<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Enhanced Encapsulating Security Payload (EESP)</title>
<meta content="Steffen Klassert" name="author">
<meta content="Antony Antony" name="author">
<meta content="Christian Hopps" name="author">
<meta content="
       This document describes the Enhanced Encapsulating Security Payload
(EESP) protocol, which builds on the existing IP Encapsulating
Security Payload (ESP) protocol. It is designed to modernize and
overcome limitations in the ESP protocol. 
       EESP adds Session IDs (e.g., to support CPU pinning and QoS support
based on the inner traffic flow), changes some previously mandatory
fields to optional, and moves the ESP trailer into the EESP header.
Additionally, EESP adds header options adapted from IPv6 to allow
for future extension. New header options are defined which add Flow IDs
and a crypt-offset to allow for exposing inner flow information for
middlebox use. 
    " name="description">
<meta content="xml2rfc 3.20.0" name="generator">
<meta content="EESP" name="keyword">
<meta content="IKEv2" name="keyword">
<meta content="draft-ietf-ipsecme-eesp-02" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.20.0
    Python 3.12.3
    ConfigArgParse 1.7
    google-i18n-address 2.4.0
    intervaltree 3.0.2
    Jinja2 3.1.2
    lxml 5.2.1
    platformdirs 4.2.0
    pycountry 23.12.11
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.1.2
    six 1.16.0
    wcwidth 0.2.5
    weasyprint 61.1
-->
<link href="draft/draft-ietf-ipsecme-eesp-02.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">/*

  NOTE: Changes at the bottom of this file overrides some earlier settings.

  Once the style has stabilized and has been adopted as an official RFC style,
  this can be consolidated so that style settings occur only in one place, but
  for now the contents of this file consists first of the initial CSS work as
  provided to the RFC Formatter (xml2rfc) work, followed by itemized and
  commented changes found necessary during the development of the v3
  formatters.

*/

/* fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans'); /* Sans-serif */
@import url('https://fonts.googleapis.com/css?family=Noto+Serif'); /* Serif (print) */
@import url('https://fonts.googleapis.com/css?family=Roboto+Mono'); /* Monospace */

:root {
  --font-sans: 'Noto Sans', Arial, Helvetica, sans-serif;
  --font-serif: 'Noto Serif', 'Times', 'Times New Roman', serif;
  --font-mono: 'Roboto Mono', Courier, 'Courier New', monospace;
}

@viewport {
  zoom: 1.0;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}
/* general and mobile first */
html {
}
body {
  max-width: 90%;
  margin: 1.5em auto;
  color: #222;
  background-color: #fff;
  font-size: 14px;
  font-family: var(--font-sans);
  line-height: 1.6;
  scroll-behavior: smooth;
  overflow-wrap: break-word;
}
.ears {
  display: none;
}

/* headings */
#title, h1, h2, h3, h4, h5, h6 {
  margin: 1em 0 0.5em;
  font-weight: bold;
  line-height: 1.3;
}
#title {
  clear: both;
  border-bottom: 1px solid #ddd;
  margin: 0 0 0.5em 0;
  padding: 1em 0 0.5em;
}
.author {
  padding-bottom: 4px;
}
h1 {
  font-size: 26px;
  margin: 1em 0;
}
h2 {
  font-size: 22px;
  margin-top: -20px;  /* provide offset for in-page anchors */
  padding-top: 33px;
}
h3 {
  font-size: 18px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h4 {
  font-size: 16px;
  margin-top: -36px;  /* provide offset for in-page anchors */
  padding-top: 42px;
}
h5, h6 {
  font-size: 14px;
}
#n-copyright-notice {
  border-bottom: 1px solid #ddd;
  padding-bottom: 1em;
  margin-bottom: 1em;
}
/* general structure */
p {
  padding: 0;
  margin: 0 0 1em 0;
  text-align: left;
}
div, span {
  position: relative;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignRight.art-text pre {
  padding: 0;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
svg[font-family~="serif" i], svg [font-family~="serif" i] {
  font-family: var(--font-serif);
}
svg[font-family~="sans-serif" i], svg [font-family~="sans-serif" i] {
  font-family: var(--font-sans);
}
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: #f9f9f9;
  border: 1px solid #eee;
  border-radius: 3px;
  padding: 1em 1em 0;
  margin-bottom: 1.5em;
}
.alignCenter.art-text pre {
  padding: 0;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  display: table;
  border: none;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 1em 2em;
}
ol ol, ul ul, ol ul, ul ol {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
ul.ulBare, li.ulBare {
  margin-left: 0em !important;
}
ul.compact, .ulCompact,
ol.compact, .olCompact {
  line-height: 100%;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
}
dl > dt {
  float: left;
  margin-right: 1em;
}
/* 
dl.nohang > dt {
  float: none;
}
*/
dl > dd {
  margin-bottom: .8em;
  min-height: 1.3em;
}
dl.compact > dd, .dlCompact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}

/* links */
a {
  text-decoration: none;
}
a[href] {
  color: #22e; /* Arlen: WCAG 2019 */
}
a[href]:hover {
  background-color: #f2f2f2;
}
figcaption a[href],
a[href].selfRef {
  color: #222;
}
/* XXX probably not this:
a.selfRef:hover {
  background-color: transparent;
  cursor: default;
} */

/* Figures */
tt, code, pre {
  background-color: #f9f9f9;
  font-family: var(--font-mono);
}
pre {
  border: 1px solid #eee;
  margin: 0;
  padding: 1em;
}
img {
  max-width: 100%;
}
figure {
  margin: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption {
  font-style: italic;
  margin: 0 0 1em 0;
}
@media screen {
  pre {
    overflow-x: auto;
    max-width: 100%;
    max-width: calc(100% - 22px);
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 1.2em 2em;
}
blockquote {
  background-color: #f9f9f9;
  color: #111; /* Arlen: WCAG 2019 */
  border: 1px solid #ddd;
  border-radius: 3px;
  margin: 1em 0;
}
blockquote > *:last-child {
  margin-bottom: 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
  border: 1px solid #eee;
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 0.5em 0.75em;
}
th {
  text-align: left;
  background-color: #e9e9e9;
}
tr:nth-child(2n+1) > td {
  background-color: #f5f5f5;
}
table caption {
  font-style: italic;
  margin: 0;
  padding: 0;
  text-align: left;
}
table p {
  /* XXX to avoid bottom margin on table row signifiers. If paragraphs should
     be allowed within tables more generally, it would be far better to select on a class. */
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  color: #666; /* Arlen: AHDJ 2019 */
  text-decoration: none;
  visibility: hidden;
  user-select: none;
  -ms-user-select: none;
  -o-user-select:none;
  -moz-user-select: none;
  -khtml-user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
}
@media screen {
  aside:hover > a.pilcrow,
  p:hover > a.pilcrow,
  blockquote:hover > a.pilcrow,
  div:hover > a.pilcrow,
  li:hover > a.pilcrow,
  pre:hover > a.pilcrow {
    visibility: visible;
  }
  a.pilcrow:hover {
    background-color: transparent;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid #eee;
}
.bcp14 {
  font-variant: small-caps;
}

.role {
  font-variant: all-small-caps;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: 0.9em;
}
#identifiers dt {
  width: 3em;
  clear: left;
}
#identifiers dd {
  float: left;
  margin-bottom: 0;
}
/* Fix PDF info block run off issue */
@media print {
  #identifiers dd {
    float: none;
  }
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #666; /* Arlen: WCAG 2019 */
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc  {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
nav.toc ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
nav.toc li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 7em;
}
.references dd {
  margin-left: 8em;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.refSubseries {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
.index ul {
  margin: 0 0 0 1em;
  padding: 0;
  list-style: none;
}
.index ul ul {
  margin: 0;
}
.index li {
  margin: 0;
  text-indent: -2em;
  padding-left: 2em;
  padding-bottom: 5px;
}
.indexIndex {
  margin: 0.5em 0 1em;
}
.index a {
  font-weight: 700;
}
/* make the index two-column on all but the smallest screens */
@media (min-width: 600px) {
  .index ul {
    -moz-column-count: 2;
    -moz-column-gap: 20px;
  }
  .index ul ul {
    -moz-column-count: 1;
    -moz-column-gap: 0;
  }
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}

address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  font-family: var(--font-sans);
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}

/* temporary notes */
.rfcEditorRemove::before {
  position: absolute;
  top: 0.2em;
  right: 0.2em;
  padding: 0.2em;
  content: "The RFC Editor will remove this note";
  color: #9e2a00; /* Arlen: WCAG 2019 */
  background-color: #ffd; /* Arlen: WCAG 2019 */
}
.rfcEditorRemove {
  position: relative;
  padding-top: 1.8em;
  background-color: #ffd; /* Arlen: WCAG 2019 */
  border-radius: 3px;
}
.cref {
  background-color: #ffd; /* Arlen: WCAG 2019 */
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 1023px) {
  body {
    padding-top: 2em;
  }
  #title {
    padding: 1em 0;
  }
  h1 {
    font-size: 24px;
  }
  h2 {
    font-size: 20px;
    margin-top: -18px;  /* provide offset for in-page anchors */
    padding-top: 38px;
  }
  #identifiers dd {
    max-width: 60%;
  }
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    background-color: inherit;
    border-bottom: 1px solid #ccc;
  }
  #toc h2 {
    margin: -1px 0 0 0;
    padding: 4px 0 4px 6px;
    padding-right: 1em;
    min-width: 190px;
    font-size: 1.1em;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 6px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    padding: 0.5em 1em 1em;
    overflow: auto;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 1024px) {
  body {
    max-width: 724px;
    margin: 42px auto;
    padding-left: 1.5em;
    padding-right: 29em;
  }
  #toc {
    position: fixed;
    top: 42px;
    right: 42px;
    width: 25%;
    margin: 0;
    padding: 0 1em;
    z-index: 1;
  }
  #toc h2 {
    border-top: none;
    border-bottom: 1px solid #ddd;
    font-size: 1em;
    font-weight: normal;
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 0;
    overflow: auto;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  .breakable pre {
    break-inside: auto;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

/* This is commented out here, as the string-set: doesn't
   pass W3C validation currently */
/*
.ears thead .left {
  string-set: ears-top-left content();
}

.ears thead .center {
  string-set: ears-top-center content();
}

.ears thead .right {
  string-set: ears-top-right content();
}

.ears tfoot .left {
  string-set: ears-bottom-left content();
}

.ears tfoot .center {
  string-set: ears-bottom-center content();
}

.ears tfoot .right {
  string-set: ears-bottom-right content();
}
*/

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
  /* The following is commented out here, but set appropriately by in code, as
     the content depends on the document */
  /*
  @top-left {
    content: 'Internet-Draft';
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-left {
    content: string(ears-top-left);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-center {
    content: string(ears-top-center);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @top-right {
    content: string(ears-top-right);
    vertical-align: bottom;
    border-bottom: solid 1px #ccc;
  }
  @bottom-left {
    content: string(ears-bottom-left);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-center {
    content: string(ears-bottom-center);
    vertical-align: top;
    border-top: solid 1px #ccc;
  }
  @bottom-right {
      content: '[Page ' counter(page) ']';
      vertical-align: top;
      border-top: solid 1px #ccc;
  }
  */

}

/* Changes introduced to fix issues found during implementation */
/* Make sure links are clickable even if overlapped by following H* */
a {
  z-index: 2;
}
/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}


/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Leave room in document info to show Internet-Draft on one line */
#identifiers dt {
  width: 8em;
}

/* Don't waste quite as much whitespace between label and value in doc info */
#identifiers dd {
  margin-left: 1em;
}

/* Give floating toc a background color (needed when it's a div inside section */
#toc {
  background-color: white;
}

/* Make the collapsed ToC header render white on gray also when it's a link */
@media screen and (max-width: 1023px) {
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
}

/* Give the bottom of the ToC some whitespace */
@media screen and (min-width: 1024px) {
  #toc {
    padding: 0 0 1em 1em;
  }
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* prevent monospace from becoming overly large */
tt, code, pre {
  font-size: 95%;
}

/* Fix the height/width aspect for ascii art*/
.sourcecode pre,
.art-text pre {
  line-height: 1.12;
}


/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin-right: 0.5em;
}

/* Fix the dl styling to match the RFC 7992 attributes */
dl > dt,
dl.dlParallel > dt {
  float: left;
  margin-right: 1em;
}
dl.dlNewline > dt {
  float: none;
}

/* Provide styling for table cell text alignment */
table td.text-left,
table th.text-left {
  text-align: left;
}
table td.text-center,
table th.text-center {
  text-align: center;
}
table td.text-right,
table th.text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 30em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Provide table alignment support.  We can't use the alignX classes above
   since they do unwanted things with caption and other styling. */
table.right {
 margin-left: auto;
 margin-right: 0;
}
table.center {
 margin-left: auto;
 margin-right: auto;
}
table.left {
 margin-left: 0;
 margin-right: auto;
}

/* Give the table caption label the same styling as the figcaption */
caption a[href] {
  color: #222;
}

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  .vcard {
    page-break-inside: avoid;
  }

}
/* Tweak the bcp14 keyword presentation */
.bcp14 {
  font-variant: small-caps;
  font-weight: bold;
  font-size: 0.9em;
}
/* Tweak the invisible space above H* in order not to overlay links in text above */
 h2 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 31px;
 }
 h3 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
 h4 {
  margin-top: -18px;  /* provide offset for in-page anchors */
  padding-top: 24px;
 }
/* Float artwork pilcrow to the right */
@media screen {
  .artwork a.pilcrow {
    display: block;
    line-height: 0.7;
    margin-top: 0.15em;
  }
}
/* Make pilcrows on dd visible */
@media screen {
  dd:hover > a.pilcrow {
    visibility: visible;
  }
}
/* Make the placement of figcaption match that of a table's caption
   by removing the figure's added bottom margin */
.alignLeft.art-text,
.alignCenter.art-text,
.alignRight.art-text {
   margin-bottom: 0;
}
.alignLeft,
.alignCenter,
.alignRight {
  margin: 1em 0 0 0;
}
/* In print, the pilcrow won't show on hover, so prevent it from taking up space,
   possibly even requiring a new line */
@media print {
  a.pilcrow {
    display: none;
  }
}
/* Styling for the external metadata */
div#external-metadata {
  background-color: #eee;
  padding: 0.5em;
  margin-bottom: 0.5em;
  display: none;
}
div#internal-metadata {
  padding: 0.5em;                       /* to match the external-metadata padding */
}
/* Styling for title RFC Number */
h1#rfcnum {
  clear: both;
  margin: 0 0 -1em;
  padding: 1em 0 0 0;
}
/* Make .olPercent look the same as <ol><li> */
dl.olPercent > dd {
  margin-bottom: 0.25em;
  min-height: initial;
}
/* Give aside some styling to set it apart */
aside {
  border-left: 1px solid #ddd;
  margin: 1em 0 1em 2em;
  padding: 0.2em 2em;
}
aside > dl,
aside > ol,
aside > ul,
aside > table,
aside > p {
  margin-bottom: 0.5em;
}
/* Additional page break settings */
@media print {
  figcaption, table caption {
    page-break-before: avoid;
  }
}
/* Font size adjustments for print */
@media print {
  body  { font-size: 10pt;      line-height: normal; max-width: 96%; }
  h1    { font-size: 1.72em;    padding-top: 1.5em; } /* 1*1.2*1.2*1.2 */
  h2    { font-size: 1.44em;    padding-top: 1.5em; } /* 1*1.2*1.2 */
  h3    { font-size: 1.2em;     padding-top: 1.5em; } /* 1*1.2 */
  h4    { font-size: 1em;       padding-top: 1.5em; }
  h5, h6 { font-size: 1em;      margin: initial; padding: 0.5em 0 0.3em; }
}
/* Sourcecode margin in print, when there's no pilcrow */
@media print {
  .artwork,
  .artwork > pre,
  .sourcecode {
    margin-bottom: 1em;
  }
}
/* Avoid narrow tables forcing too narrow table captions, which may render badly */
table {
  min-width: 20em;
}
/* ol type a */
ol.type-a { list-style-type: lower-alpha; }
ol.type-A { list-style-type: upper-alpha; }
ol.type-i { list-style-type: lower-roman; }
ol.type-I { list-style-type: lower-roman; }
/* Apply the print table and row borders in general, on request from the RPC,
and increase the contrast between border and odd row background slightly */
table {
  border: 1px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
}
tr {
  break-inside: avoid;
}
tr:nth-child(2n+1) > td {
  background-color: #f8f8f8;
}
/* Use style rules to govern display of the TOC. */
@media screen and (max-width: 1023px) {
  #toc nav { display: none; }
  #toc.active nav { display: block; }
}
/* Add support for keepWithNext */
.keepWithNext {
  break-after: avoid-page;
  break-after: avoid-page;
}
/* Add support for keepWithPrevious */
.keepWithPrevious {
  break-before: avoid-page;
}
/* Change the approach to avoiding breaks inside artwork etc. */
figure, pre, table, .artwork, .sourcecode  {
  break-before: auto;
  break-after: auto;
}
/* Avoid breaks between <dt> and <dd> */
dl {
  break-before: auto;
  break-inside: auto;
}
dt {
  break-before: auto;
  break-after: avoid-page;
}
dd {
  break-before: avoid-page;
  break-after: auto;
  orphans: 3;
  widows: 3
}
span.break, dd.break {
  margin-bottom: 0;
  min-height: 0;
  break-before: auto;
  break-inside: auto;
  break-after: auto;
}
/* Undo break-before ToC */
@media print {
  #toc {
    break-before: auto;
  }
}
/* Text in compact lists should not get extra bottom margin space,
   since that would makes the list not compact */
ul.compact p, .ulCompact p,
ol.compact p, .olCompact p {
 margin: 0;
}
/* But the list as a whole needs the extra space at the end */
section ul.compact,
section .ulCompact,
section ol.compact,
section .olCompact {
  margin-bottom: 1em;                    /* same as p not within ul.compact etc. */
}
/* The tt and code background above interferes with for instance table cell
   backgrounds.  Changed to something a bit more selective. */
tt, code {
  background-color: transparent;
}
p tt, p code, li tt, li code {
  background-color: #f8f8f8;
}
/* Tweak the pre margin -- 0px doesn't come out well */
pre {
   margin-top: 0.5px;
}
/* Tweak the compact list text */
ul.compact, .ulCompact,
ol.compact, .olCompact,
dl.compact, .dlCompact {
  line-height: normal;
}
/* Don't add top margin for nested lists */
li > ul, li > ol, li > dl,
dd > ul, dd > ol, dd > dl,
dl > dd > dl {
  margin-top: initial;
}
/* Elements that should not be rendered on the same line as a <dt> */
/* This should match the element list in writer.text.TextWriter.render_dl() */
dd > div.artwork:first-child,
dd > aside:first-child,
dd > figure:first-child,
dd > ol:first-child,
dd > div.sourcecode:first-child,
dd > table:first-child,
dd > ul:first-child {
  clear: left;
}
/* fix for weird browser behaviour when <dd/> is empty */
dt+dd:empty::before{
  content: "\00a0";
}
/* Make paragraph spacing inside <li> smaller than in body text, to fit better within the list */
li > p {
  margin-bottom: 0.5em
}
/* Don't let p margin spill out from inside list items */
li > p:last-of-type:only-child {
  margin-bottom: 0;
}
</style>
<link href="rfc-local.css" rel="stylesheet" type="text/css">
<script type="application/javascript">async function addMetadata(){try{const e=document.styleSheets[0].cssRules;for(let t=0;t<e.length;t++)if(/#identifiers/.exec(e[t].selectorText)){const a=e[t].cssText.replace("#identifiers","#external-updates");document.styleSheets[0].insertRule(a,document.styleSheets[0].cssRules.length)}}catch(e){console.log(e)}const e=document.getElementById("external-metadata");if(e)try{var t,a="",o=function(e){const t=document.getElementsByTagName("meta");for(let a=0;a<t.length;a++)if(t[a].getAttribute("name")===e)return t[a].getAttribute("content");return""}("rfc.number");if(o){t="https://www.rfc-editor.org/rfc/rfc"+o+".json";try{const e=await fetch(t);a=await e.json()}catch(e){t=document.URL.indexOf("html")>=0?document.URL.replace(/html$/,"json"):document.URL+".json";const o=await fetch(t);a=await o.json()}}if(!a)return;e.style.display="block";const s="",d="https://datatracker.ietf.org/doc",n="https://datatracker.ietf.org/ipr/search",c="https://www.rfc-editor.org/info",l=a.doc_id.toLowerCase(),i=a.doc_id.slice(0,3).toLowerCase(),f=a.doc_id.slice(3).replace(/^0+/,""),u={status:"Status",obsoletes:"Obsoletes",obsoleted_by:"Obsoleted By",updates:"Updates",updated_by:"Updated By",see_also:"See Also",errata_url:"Errata"};let h="<dl style='overflow:hidden' id='external-updates'>";["status","obsoletes","obsoleted_by","updates","updated_by","see_also","errata_url"].forEach(e=>{if("status"==e){a[e]=a[e].toLowerCase();var t=a[e].split(" "),o=t.length,w="",p=1;for(let e=0;e<o;e++)p<o?w=w+r(t[e])+" ":w+=r(t[e]),p++;a[e]=w}else if("obsoletes"==e||"obsoleted_by"==e||"updates"==e||"updated_by"==e){var g,m="",b=1;g=a[e].length;for(let t=0;t<g;t++)a[e][t]&&(a[e][t]=String(a[e][t]).toLowerCase(),m=b<g?m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>, ":m+"<a href='"+s+"/rfc/".concat(a[e][t])+"'>"+a[e][t].slice(3)+"</a>",b++);a[e]=m}else if("see_also"==e){var y,L="",C=1;y=a[e].length;for(let t=0;t<y;t++)if(a[e][t]){a[e][t]=String(a[e][t]);var _=a[e][t].slice(0,3),v=a[e][t].slice(3).replace(/^0+/,"");L=C<y?"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>, ":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>, ":"RFC"!=_?L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+_+" "+v+"</a>":L+"<a href='"+s+"/info/"+_.toLowerCase().concat(v.toLowerCase())+"'>"+v+"</a>",C++}a[e]=L}else if("errata_url"==e){var R="";R=a[e]?R+"<a href='"+a[e]+"'>Errata exist</a> | <a href='"+d+"/"+l+"'>Datatracker</a>| <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>":"<a href='"+d+"/"+l+"'>Datatracker</a> | <a href='"+n+"/?"+i+"="+f+"&submit="+i+"'>IPR</a> | <a href='"+c+"/"+l+"'>Info page</a>",a[e]=R}""!=a[e]?"Errata"==u[e]?h+=`<dt>More info:</dt><dd>${a[e]}</dd>`:h+=`<dt>${u[e]}:</dt><dd>${a[e]}</dd>`:"Errata"==u[e]&&(h+=`<dt>More info:</dt><dd>${a[e]}</dd>`)}),h+="</dl>",e.innerHTML=h}catch(e){console.log(e)}else console.log("Could not locate metadata <div> element");function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}}window.removeEventListener("load",addMetadata),window.addEventListener("load",addMetadata);</script>
</head>
<body class="xml2rfc">
<script src="metadata.min.js"></script>
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">EESP</td>
<td class="right">October 2025</td>
</tr></thead>
<tfoot><tr>
<td class="left">Klassert, et al.</td>
<td class="center">Expires 23 April 2026</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">IPSECME Working Group</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2025-10-20" class="published">20 October 2025</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Standards Track</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2026-04-23">23 April 2026</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">S. Klassert</div>
<div class="org">secunet</div>
</div>
<div class="author">
      <div class="author-name">A. Antony</div>
<div class="org">secunet</div>
</div>
<div class="author">
      <div class="author-name">C. Hopps</div>
<div class="org">LabN Consulting, L.L.C.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Enhanced Encapsulating Security Payload (EESP)</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes the Enhanced Encapsulating Security Payload
(EESP) protocol, which builds on the existing IP Encapsulating
Security Payload (ESP) protocol. It is designed to modernize and
overcome limitations in the ESP protocol.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
<p id="section-abstract-2">EESP adds Session IDs (e.g., to support CPU pinning and QoS support
based on the inner traffic flow), changes some previously mandatory
fields to optional, and moves the ESP trailer into the EESP header.
Additionally, EESP adds header options adapted from IPv6 to allow
for future extension. New header options are defined which add Flow IDs
and a crypt-offset to allow for exposing inner flow information for
middlebox use.<a href="#section-abstract-2" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 23 April 2026.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2025 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-3">
            This document may contain material from IETF Documents or IETF
            Contributions published or made publicly available before November
            10, 2008. The person(s) controlling the copyright in some of this
            material may not have granted the IETF Trust the right to allow
            modifications of such material outside the IETF Standards Process.
            Without obtaining an adequate license from the person(s)
            controlling the copyright in such materials, this document may not
            be modified outside the IETF Standards Process, and derivative
            works of it may not be created outside the IETF Standards Process,
            except to format it for publication as an RFC or to translate it
            into languages other than English.<a href="#section-boilerplate.2-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.1">
                <p id="section-toc.1-1.1.2.1.1" class="keepWithNext"><a href="#section-1.1" class="auto internal xref">1.1</a>.  <a href="#name-requirements-language" class="internal xref">Requirements Language</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1.2.2">
                <p id="section-toc.1-1.1.2.2.1" class="keepWithNext"><a href="#section-1.2" class="auto internal xref">1.2</a>.  <a href="#name-terminology" class="internal xref">Terminology</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-enhanced-encapsulating-secu" class="internal xref">Enhanced Encapsulating Security Payload Packet Format</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1" class="auto internal xref">2.1</a>.  <a href="#name-top-level-eesp-format" class="internal xref">Top-Level EESP format</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2">
                <p id="section-toc.1-1.2.2.2.1"><a href="#section-2.2" class="auto internal xref">2.2</a>.  <a href="#name-base-header" class="internal xref">Base Header</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2.2.1">
                    <p id="section-toc.1-1.2.2.2.2.1.1"><a href="#section-2.2.1" class="auto internal xref">2.2.1</a>.  <a href="#name-fixed-base-header" class="internal xref">Fixed Base Header</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.2.2.2">
                    <p id="section-toc.1-1.2.2.2.2.2.1"><a href="#section-2.2.2" class="auto internal xref">2.2.2</a>.  <a href="#name-base-header-options" class="internal xref">Base Header Options</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3">
                <p id="section-toc.1-1.2.2.3.1"><a href="#section-2.3" class="auto internal xref">2.3</a>.  <a href="#name-peer-header" class="internal xref">Peer Header</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3.2.1">
                    <p id="section-toc.1-1.2.2.3.2.1.1"><a href="#section-2.3.1" class="auto internal xref">2.3.1</a>.  <a href="#name-sequence-number" class="internal xref">Sequence Number</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.3.2.2">
                    <p id="section-toc.1-1.2.2.3.2.2.1"><a href="#section-2.3.2" class="auto internal xref">2.3.2</a>.  <a href="#name-initialization-vector" class="internal xref">Initialization Vector</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4">
                <p id="section-toc.1-1.2.2.4.1"><a href="#section-2.4" class="auto internal xref">2.4</a>.  <a href="#name-payload-info-header" class="internal xref">Payload Info Header</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4.2.1">
                    <p id="section-toc.1-1.2.2.4.2.1.1"><a href="#section-2.4.1" class="auto internal xref">2.4.1</a>.  <a href="#name-next-header" class="internal xref">Next Header</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.4.2.2">
                    <p id="section-toc.1-1.2.2.4.2.2.1"><a href="#section-2.4.2" class="auto internal xref">2.4.2</a>.  <a href="#name-pad-length" class="internal xref">Pad Length</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.5">
                <p id="section-toc.1-1.2.2.5.1"><a href="#section-2.5" class="auto internal xref">2.5</a>.  <a href="#name-payload-data" class="internal xref">Payload Data</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.6">
                <p id="section-toc.1-1.2.2.6.1"><a href="#section-2.6" class="auto internal xref">2.6</a>.  <a href="#name-padding-for-encryption" class="internal xref">Padding (for Encryption)</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.7">
                <p id="section-toc.1-1.2.2.7.1"><a href="#section-2.7" class="auto internal xref">2.7</a>.  <a href="#name-integrity-check-value-icv" class="internal xref">Integrity Check Value (ICV)</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.8">
                <p id="section-toc.1-1.2.2.8.1"><a href="#section-2.8" class="auto internal xref">2.8</a>.  <a href="#name-full-and-optimized-packet-f" class="internal xref">Full and Optimized Packet Formats</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.9">
                <p id="section-toc.1-1.2.2.9.1"><a href="#section-2.9" class="auto internal xref">2.9</a>.  <a href="#name-session-id-as-sub-sa-id" class="internal xref">Session ID as Sub SA ID</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.9.2.1">
                    <p id="section-toc.1-1.2.2.9.2.1.1"><a href="#section-2.9.1" class="auto internal xref">2.9.1</a>.  <a href="#name-sender-behavior" class="internal xref">Sender Behavior</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2.2.9.2.2">
                    <p id="section-toc.1-1.2.2.9.2.2.1"><a href="#section-2.9.2" class="auto internal xref">2.9.2</a>.  <a href="#name-receiver-behavior" class="internal xref">Receiver Behavior</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-eesp-header-options" class="internal xref">EESP Header Options</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-eesp-option-types" class="internal xref">EESP Option Types</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1.2.1">
                    <p id="section-toc.1-1.3.2.1.2.1.1"><a href="#section-3.1.1" class="auto internal xref">3.1.1</a>.  <a href="#name-padding-options" class="internal xref">Padding Options</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1.2.2">
                    <p id="section-toc.1-1.3.2.1.2.2.1"><a href="#section-3.1.2" class="auto internal xref">3.1.2</a>.  <a href="#name-eesp-flow-identifier-option" class="internal xref">EESP Flow Identifier Option</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1.2.3">
                    <p id="section-toc.1-1.3.2.1.2.3.1"><a href="#section-3.1.3" class="auto internal xref">3.1.3</a>.  <a href="#name-eesp-crypt-offset-option" class="internal xref">EESP Crypt Offset Option</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-enhanced-encapsulating-secur" class="internal xref">Enhanced Encapsulating Security Protocol Processing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-eesp-header-location" class="internal xref">EESP Header Location</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1" class="auto internal xref">4.1.1</a>.  <a href="#name-layer-4-encapsulation-modes" class="internal xref">Layer 4 Encapsulation Modes</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2" class="auto internal xref">4.1.2</a>.  <a href="#name-tunnel-mode-processing" class="internal xref">Tunnel Mode Processing</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-aad-construction" class="internal xref">AAD Construction</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-algorithms" class="internal xref">Algorithms</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3.2.1">
                    <p id="section-toc.1-1.4.2.3.2.1.1"><a href="#section-4.3.1" class="auto internal xref">4.3.1</a>.  <a href="#name-combined-mode-algorithms" class="internal xref">Combined Mode Algorithms</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4">
                <p id="section-toc.1-1.4.2.4.1"><a href="#section-4.4" class="auto internal xref">4.4</a>.  <a href="#name-outbound-packet-processing" class="internal xref">Outbound Packet Processing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.1">
                    <p id="section-toc.1-1.4.2.4.2.1.1"><a href="#section-4.4.1" class="auto internal xref">4.4.1</a>.  <a href="#name-security-association-lookup" class="internal xref">Security Association Lookup</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.2">
                    <p id="section-toc.1-1.4.2.4.2.2.1"><a href="#section-4.4.2" class="auto internal xref">4.4.2</a>.  <a href="#name-packet-encryption-and-integ" class="internal xref">Packet Encryption and Integrity Check Value (ICV) Calculation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.3">
                    <p id="section-toc.1-1.4.2.4.2.3.1"><a href="#section-4.4.3" class="auto internal xref">4.4.3</a>.  <a href="#name-combined-confidentiality-an" class="internal xref">Combined Confidentiality and Integrity Algorithms</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.4">
                    <p id="section-toc.1-1.4.2.4.2.4.1"><a href="#section-4.4.4" class="auto internal xref">4.4.4</a>.  <a href="#name-sequence-number-generation" class="internal xref">Sequence Number Generation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.4.2.5">
                    <p id="section-toc.1-1.4.2.4.2.5.1"><a href="#section-4.4.5" class="auto internal xref">4.4.5</a>.  <a href="#name-fragmentation" class="internal xref">Fragmentation</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5">
                <p id="section-toc.1-1.4.2.5.1"><a href="#section-4.5" class="auto internal xref">4.5</a>.  <a href="#name-inbound-packet-processing" class="internal xref">Inbound Packet Processing</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.1">
                    <p id="section-toc.1-1.4.2.5.2.1.1"><a href="#section-4.5.1" class="auto internal xref">4.5.1</a>.  <a href="#name-reassembly" class="internal xref">Reassembly</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.2">
                    <p id="section-toc.1-1.4.2.5.2.2.1"><a href="#section-4.5.2" class="auto internal xref">4.5.2</a>.  <a href="#name-security-association-lookup-2" class="internal xref">Security Association Lookup</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.3">
                    <p id="section-toc.1-1.4.2.5.2.3.1"><a href="#section-4.5.3" class="auto internal xref">4.5.3</a>.  <a href="#name-sequence-number-verificatio" class="internal xref">Sequence Number Verification</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.5.2.4">
                    <p id="section-toc.1-1.4.2.5.2.4.1"><a href="#section-4.5.4" class="auto internal xref">4.5.4</a>.  <a href="#name-packet-decryption-and-integ" class="internal xref">Packet Decryption and Integrity Check Value Verification</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-key-derivation-for-sub-sas" class="internal xref">Key Derivation for Sub SAs</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-udp-encapsulation" class="internal xref">UDP Encapsulation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-udp-encapsulation-of-sub-sa" class="internal xref">UDP Encapsulation of Sub SAs</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-auditing" class="internal xref">Auditing</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-conformance-requirements" class="internal xref">Conformance Requirements</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10" class="auto internal xref">10</a>. <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1" class="auto internal xref">10.1</a>.  <a href="#name-eesp-ip-protocol-number" class="internal xref">EESP IP Protocol Number</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.2">
                <p id="section-toc.1-1.10.2.2.1"><a href="#section-10.2" class="auto internal xref">10.2</a>.  <a href="#name-eesp-versions-registry" class="internal xref">EESP Versions Registry</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10.2.3">
                <p id="section-toc.1-1.10.2.3.1"><a href="#section-10.3" class="auto internal xref">10.3</a>.  <a href="#name-eesp-options-registry" class="internal xref">EESP Options Registry</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11" class="auto internal xref">11</a>. <a href="#name-implementation-status" class="internal xref">Implementation Status</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12" class="auto internal xref">12</a>. <a href="#name-acknowledgments" class="internal xref">Acknowledgments</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13" class="auto internal xref">13</a>. <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14" class="auto internal xref">14</a>. <a href="#name-informative-references" class="internal xref">Informative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#appendix-A" class="auto internal xref">Appendix A</a>.  <a href="#name-additional-stuff" class="internal xref">Additional Stuff</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">Due to the absence of a version number in the packet header of the ESP
protocol, ESP can't be updated in a transparent way. Any updates
to ESP must be negotiated by IKEv2 and are therefore indiscernible to
intermediate devices such as routers and firewalls. In the recent
past, several attempts were taken to introduce a Flow Identifier for
certain use cases. Examples are
<span>[<a href="#I-D.ponchon-ipsecme-anti-replay-subspaces" class="cite xref">I-D.ponchon-ipsecme-anti-replay-subspaces</a>]</span> and
<span>[<a href="#I-D.he-ipsecme-vpn-shared-ipsecsa" class="cite xref">I-D.he-ipsecme-vpn-shared-ipsecsa</a>]</span>. Such a Flow Identifier could
also be used to perform ECMP based on the inner flows at intermediate
devices or endpoints.  Additionally to that, there exists a
specification of the <span>[<a href="#PSP" class="cite xref">PSP</a>]</span> protocol that has the need of a Flow
Identifier, called Network Identifier (VNI) there. PSP also defines a
Crypt Offset to expose parts of the headers of the inner packet.
EESP provides a solution for all the aforementioned use cases.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">This document defines a Session ID and a Crypt Offset Option
along with a generic Flow Identifier Option.
Future documents can define the meaning of additional Options
for their particular use-case. With this, all existing and potential new
use cases can be covered. For instance, it can be
used for the case of <span>[<a href="#I-D.ponchon-ipsecme-anti-replay-subspaces" class="cite xref">I-D.ponchon-ipsecme-anti-replay-subspaces</a>]</span> or
<span>[<a href="#I-D.he-ipsecme-vpn-shared-ipsecsa" class="cite xref">I-D.he-ipsecme-vpn-shared-ipsecsa</a>]</span> etc., or combinations thereof. EESP
does not have a trailer as ESP had, instead the Next Header and Pad
Length values are moved to the EESP header. Additionally, an optimized
EESP header is defined which eliminates these 2 values when using simple
IPv4 or IPv6 tunnel mode. EESP also does not define TFC padding, IP-TFS
as of <span>[<a href="#RFC9347" class="cite xref">RFC9347</a>]</span> SHOULD be used instead. A detailed discussion
about the problems of the ESP protocol can be found in
<span>[<a href="#I-D.mrossberg-ipsecme-multiple-sequence-counters" class="cite xref">I-D.mrossberg-ipsecme-multiple-sequence-counters</a>]</span>.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">EESP follows the Security Architecture for the Internet Protocol
<span>[<a href="#RFC4301" class="cite xref">RFC4301</a>]</span> and uses ESP as of <span>[<a href="#RFC4303" class="cite xref">RFC4303</a>]</span> as reference. That means
this document is seen as a modern version of ESP (with new protocol
number), but it follows the design principles of ESP. Protocol parts that
are not mentioned here MUST be handled exactly the way as specified
in <span>[<a href="#RFC4303" class="cite xref">RFC4303</a>]</span>. EESP neither updates nor obsoletes <span>[<a href="#RFC4303" class="cite xref">RFC4303</a>]</span>.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">EESP focuses on modern algorithms, hence it defines the use of
combined mode algorithms only. This means that the integrity
option is always taken.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">Though this document specifies IKEv2 as a negotiation protocol, EESP
may use other protocols for negotiation and key derivation. The
packet specification is portable to other keying protocol use cases,
such as <span>[<a href="#PSP" class="cite xref">PSP</a>]</span>, and offers versioning at the packet level.
The Flow Identifiers, Crypt Offset and the Session ID can
be used to cover the PSP use case.<a href="#section-1-5" class="pilcrow">¶</a></p>
<section id="section-1.1">
        <h3 id="name-requirements-language">
<a href="#section-1.1" class="section-number selfRef">1.1. </a><a href="#name-requirements-language" class="section-name selfRef">Requirements Language</a>
        </h3>
<p id="section-1.1-1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
"SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
document are to be interpreted as described in <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span>.<a href="#section-1.1-1" class="pilcrow">¶</a></p>
</section>
<section id="section-1.2">
        <h3 id="name-terminology">
<a href="#section-1.2" class="section-number selfRef">1.2. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
        </h3>
<p id="section-1.2-1">This document uses the following terms defined in IKEv2 <span>[<a href="#RFC7296" class="cite xref">RFC7296</a>]</span>:
Child SA, CREATE_CHILD_SA, IKE_AUTH exchange, USE_TRANSPORT_MODE<a href="#section-1.2-1" class="pilcrow">¶</a></p>
<p id="section-1.2-2">This document uses the following terms defined in <span>[<a href="#PSP" class="cite xref">PSP</a>]</span>: PSP (a
recursive acronym for PSP Security Protocol), Virtual Network Identifier
(VNI), Crypt Offset.<a href="#section-1.2-2" class="pilcrow">¶</a></p>
<p id="section-1.2-3">This document uses the following terms defined in <span>[<a href="#RFC2992" class="cite xref">RFC2992</a>]</span>:
Equal-cost multi-path (ECMP)<a href="#section-1.2-3" class="pilcrow">¶</a></p>
<p id="section-1.2-4">This document uses the following terms defined in <span>[<a href="#RFC4303" class="cite xref">RFC4303</a>]</span>:
Encapsulating Security Payload (ESP).<a href="#section-1.2-4" class="pilcrow">¶</a></p>
<p id="section-1.2-5">This document uses the following terms defined in
<span>[<a href="#I-D.mrossberg-ipsecme-multiple-sequence-counters" class="cite xref">I-D.mrossberg-ipsecme-multiple-sequence-counters</a>]</span>: Sub-Child SA.<a href="#section-1.2-5" class="pilcrow">¶</a></p>
<p id="section-1.2-6">This document uses the following terms defined in <span>[<a href="#RFC3948" class="cite xref">RFC3948</a>]</span>:
Non-ESP Marker.<a href="#section-1.2-6" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-2">
      <h2 id="name-enhanced-encapsulating-secu">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-enhanced-encapsulating-secu" class="section-name selfRef">Enhanced Encapsulating Security Payload Packet Format</a>
      </h2>
<p id="section-2-1">This section defines the exact packet formats, the
section is normative.<a href="#section-2-1" class="pilcrow">¶</a></p>
<section id="section-2.1">
        <h3 id="name-top-level-eesp-format">
<a href="#section-2.1" class="section-number selfRef">2.1. </a><a href="#name-top-level-eesp-format" class="section-name selfRef">Top-Level EESP format</a>
        </h3>
<p id="section-2.1-1">The (outer) protocol header (IPv4, IPv6, or Extension) that
immediately precedes the EESP header SHALL contain the value TBD in
its <span>[<a href="#Protocol" class="cite xref">Protocol</a>]</span> (IPv4) or Next Header (IPv6, Extension) field.
<a href="#eesp-top-level-packet-format" class="auto internal xref">Figure 1</a> illustrates the top-level format of
an EESP packet. The EESP header is split into multiple parts.<a href="#section-2.1-1" class="pilcrow">¶</a></p>
<span id="name-top-level-format-of-an-eesp"></span><div id="eesp-top-level-packet-format">
<figure id="figure-1">
          <div class="sourcecode" id="section-2.1-2.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                          Base Header                          ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                     Peer Header (variable)                    ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                 Payload Info Header (optional)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      Payload Data (variable)                  |
~                                                               ~
|               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               |          Padding (0-255 bytes)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-top-level-format-of-an-eesp" class="selfRef">Top-Level Format of an EESP Packet</a>
          </figcaption></figure>
</div>
<p id="section-2.1-3">The packet starts with a '<code>Base Header</code>' that can be used by protocol
parsing engines of middleboxes such as routers or firewalls in
addition to the IPsec peers that use it to route the packet to the
correct cryptographic context.<a href="#section-2.1-3" class="pilcrow">¶</a></p>
<p id="section-2.1-4">The '<code>Peer Header</code>' follows the '<code>Base Header</code>'. The '<code>Peer Header</code>' is
used to support replay protection and to store cryptographic
synchronization data, e.g., an Initialization Vector (IV)
for the IPsec peer. The '<code>Peer Header</code>' is only meaningful to the
IPsec peers.<a href="#section-2.1-4" class="pilcrow">¶</a></p>
<p id="section-2.1-5">Unlike ESP, EESP does not have a trailer. Instead, these values have
moved to a '<code>Payload Info Header</code>' directly following the '<code>Peer Header</code>'.
With classic transport and tunnel mode, the '<code>Payload Info Header</code>'
is encrypted, and therefore private to the IPsec peers. However,
with a positive crypt offset
(see <a href="#sec-eesp-crypt-offset-option" class="auto internal xref">Section 3.1.3</a>), the '<code>Payload Info Header</code>'
might be left unencrypted. In this case, protocol parsing engines
of middleboxes can act upon it (e.g., for telemetry).<a href="#section-2.1-5" class="pilcrow">¶</a></p>
<p id="section-2.1-6">The '<code>Payload Data</code>' follows these 3 header parts, and has a structure
that depends on the choice of encryption algorithm and mode.<a href="#section-2.1-6" class="pilcrow">¶</a></p>
<p id="section-2.1-7">'<code>Padding</code>' is an optional field following the '<code>Payload Data</code>',
primarily for alignment when using a block cipher.<a href="#section-2.1-7" class="pilcrow">¶</a></p>
<p id="section-2.1-8">Finally, the packet ends with an '<code>Integrity Check Value</code>' (ICV)
(see <a href="#sec-packet-encryption-and-integrity-check-value-icv-calculation" class="auto internal xref">Section 4.4.2</a>).
The length of this ICV depends on the cryptographic suite.<a href="#section-2.1-8" class="pilcrow">¶</a></p>
</section>
<section id="section-2.2">
        <h3 id="name-base-header">
<a href="#section-2.2" class="section-number selfRef">2.2. </a><a href="#name-base-header" class="section-name selfRef">Base Header</a>
        </h3>
<p id="section-2.2-1">The '<code>Base Header</code>' is comprised of a fixed base header followed by an
optional '<code>Options</code>' field. IPsec Peers and middleboxes MAY act upon
the Base Header and any possible Options.<a href="#section-2.2-1" class="pilcrow">¶</a></p>
<section id="section-2.2.1">
          <h4 id="name-fixed-base-header">
<a href="#section-2.2.1" class="section-number selfRef">2.2.1. </a><a href="#name-fixed-base-header" class="section-name selfRef">Fixed Base Header</a>
          </h4>
<p id="section-2.2.1-1">The fixed portion of the base header is defined as follows.<a href="#section-2.2.1-1" class="pilcrow">¶</a></p>
<span id="name-fixed-base-header-2"></span><div id="base-header">
<figure id="figure-2">
            <div class="sourcecode" id="section-2.2.1-2.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|Version|  R  |    Opt Len    |         Session ID            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              SPI                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-fixed-base-header-2" class="selfRef">Fixed Base Header</a>
            </figcaption></figure>
</div>
<span class="break"></span><dl class="dlParallel" id="section-2.2.1-3">
            <dt id="section-2.2.1-3.1">ESP compatibility</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.2">
              <p id="section-2.2.1-3.2.1">1 bit : set to 1 for compatibility with
ESP-in-UDP. ESP-in-UDP SAs MAY set this bit, the most significant
bit of the SPI, to 0.<a href="#section-2.2.1-3.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-2.2.1-3.3">Version</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.4">
              <p id="section-2.2.1-3.4.1">4 bits: MUST be set to zero and checked by the receiver.
If the version is different than an expected version
number (e.g., negotiated via the control channel), then the packet
MUST be dropped by the receiver. Future modifications to the EESP
header require a new version number. In particular, the version of
EESP defined in this document does not allow for any extensions.
Intermediate nodes dealing with unknown versions are not
necessarily able to parse the packet correctly. Intermediate
treatment of such packets is policy-dependent (e.g., it may dictate
dropping such packets).<a href="#section-2.2.1-3.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-2.2.1-3.5">Reserved (R)</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.6">
              <p id="section-2.2.1-3.6.1">3 bits: Reserved for future versions, MUST be set to zero
and checked by the receiver. If the reserved bits are different to zero,
the packet MUST be dropped by the receiver.<a href="#section-2.2.1-3.6.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-2.2.1-3.7">Opt Len</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.8">
              <p id="section-2.2.1-3.8.1">8 bits: Length in bytes of the '<code>Options</code>' field.<a href="#section-2.2.1-3.8.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-2.2.1-3.9">Session ID</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.10">
              <p id="section-2.2.1-3.10.1">16 bits: The Session ID covers additional information
that might be used to identify the SA.
For instance, it can be used to encode a Sub SA ID. The meaning of
that field is opaque and MAY be
negotiated by IKEv2. This document defines the use of the Session ID
as a Subs SA ID. Other use cases are not covered in this document.<a href="#section-2.2.1-3.10.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-2.2.1-3.11">Security Parameter Index (SPI)</dt>
            <dd style="margin-left: 1.5em" id="section-2.2.1-3.12">
              <p id="section-2.2.1-3.12.1">32 bits: The SPI is an arbitrary
32-bit value that is used by a receiver to identify the SA to which
an incoming packet is bound.<a href="#section-2.2.1-3.12.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
</section>
<section id="section-2.2.2">
          <h4 id="name-base-header-options">
<a href="#section-2.2.2" class="section-number selfRef">2.2.2. </a><a href="#name-base-header-options" class="section-name selfRef">Base Header Options</a>
          </h4>
<p id="section-2.2.2-1">The base header '<code>Options</code>' field is optional, its size is given in the
fixed header field '<code>Opt Len</code>' and may be zero if no options are
present.<a href="#section-2.2.2-1" class="pilcrow">¶</a></p>
<p id="section-2.2.2-2">When present, the '<code>Options</code>' field carries a variable number of
type-length-value (TLV) encoded options. The format of these options
has been derived from the IPv6 extension header options as defined in
Section 4.2 of <span>[<a href="#RFC8200" class="cite xref">RFC8200</a>]</span>, with the following exceptions. No special
meaning is attached to the top 3 bits of the option type value, and
the processing order of the options is not restricted.<a href="#section-2.2.2-2" class="pilcrow">¶</a></p>
<p id="section-2.2.2-3">Option type values are allocated from one of two ranges of values.
One range is used for standardized option types and the second
range is reserved for private options.<a href="#section-2.2.2-3" class="pilcrow">¶</a></p>
<p id="section-2.2.2-4">This document defines 4 initial standard option types, '<code>Pad1 Option</code>',
'<code>PadN Option</code>', '<code>Flow Identifier Option</code>', and '<code>Crypt Offset Option</code>'.
These options are defined in section <a href="#sec-eesp-option-types" class="auto internal xref">Section 3.1</a>.<a href="#section-2.2.2-4" class="pilcrow">¶</a></p>
<p id="section-2.2.2-5">Private options use '<code>Option Type</code>' values from the private option
reserved range and can be used for any purposes that are out of scope
for standardization. For example, they can be used to encode hardware
specific information, such as used encryption/authentication
algorithms as done in <span>[<a href="#PSP" class="cite xref">PSP</a>]</span>.<a href="#section-2.2.2-5" class="pilcrow">¶</a></p>
<section id="section-2.2.2.1">
            <h5 id="name-options-field-end-alignment">
<a href="#section-2.2.2.1" class="section-number selfRef">2.2.2.1. </a><a href="#name-options-field-end-alignment" class="section-name selfRef">Options Field End-Alignment</a>
            </h5>
<p id="section-2.2.2.1-1">When options are present, padding options (i.e., '<code>Pad1</code>' and '<code>PadN</code>')
MUST be used to align the fields following the '<code>Options</code>' field. This
alignment is dictated by the packet format, see <a href="#sec-payload-data" class="auto internal xref">Section 2.5</a>.<a href="#section-2.2.2.1-1" class="pilcrow">¶</a></p>
</section>
</section>
</section>
<section id="section-2.3">
        <h3 id="name-peer-header">
<a href="#section-2.3" class="section-number selfRef">2.3. </a><a href="#name-peer-header" class="section-name selfRef">Peer Header</a>
        </h3>
<p id="section-2.3-1">The '<code>Peer Header</code>' follows the '<code>Base Header</code>' and '<code>Options</code>' field.
The Peer Header is private to the IPsec peers, middleboxes MUST
NOT act upon the Peer Header fields. Peer Header fields are
optional and MUST be
negotiated by IKEv2 or any other appropriate protocol, therefore
is is not parsable by middelboxes. This document defines two
Peer Header fileds, a '<code>Sequence Number</code>' and an
'<code>Initialization Vector</code>', the format is shown below.
Future documents can define additional Peer Header fields
based on their needs.<a href="#section-2.3-1" class="pilcrow">¶</a></p>
<span id="name-peer-header-2"></span><div id="peer-header">
<figure id="figure-3">
          <div class="sourcecode" id="section-2.3-2.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Sequence Number (optional)                 |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                          IV (optional)                        ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-3" class="selfRef">Figure 3</a>:
<a href="#name-peer-header-2" class="selfRef">Peer Header</a>
          </figcaption></figure>
</div>
<p id="section-2.3-3">If present, the '<code>Sequence Number</code>' is a full 64bit sequence number.
EESP only support 64bit sequence numbers, a.k.a ESN and transmits the
entire sequence number on each packet. The actual size of the
'<code>Initialization Vector</code>' depends on the choice of the cipher suite.<a href="#section-2.3-3" class="pilcrow">¶</a></p>
<p id="section-2.3-4">The '<code>Sequence Number</code>' and '<code>Initialization Vector</code>' fields are defined
in the following sections.<a href="#section-2.3-4" class="pilcrow">¶</a></p>
<div id="sec-sequence-number">
<section id="section-2.3.1">
          <h4 id="name-sequence-number">
<a href="#section-2.3.1" class="section-number selfRef">2.3.1. </a><a href="#name-sequence-number" class="section-name selfRef">Sequence Number</a>
          </h4>
<p id="section-2.3.1-1">The sequence number field is used for replay protection.
This unsigned 64-bit field contains a counter value that increases
for each packet sent, i.e., a per-SA packet sequence number. For a
unicast SA or a single-sender multicast SA, the sender MUST increment
this field for every transmitted packet. The sequence number MUST
increase strictly monotonically, sequence numbers MUST NOT repeat and
MUST NOT cycle for any given SA. Thus, the sender's counter and the
receiver's counter MUST be reset (by establishing a new SA and thus a
new key) prior to the transmission of the 2^64nd packet on an SA.
Implementations that do replay protection SHOULD increase the
sequence number by one for each sent packet. Even if recommended to
increase the sequence number by one, implementations MAY employ other
methods to increase the sequence number, as long as the
aforementioned requirements are met. Sharing an SA among multiple
senders is permitted, though generally not recommended. This document
provides no means of synchronizing packet counters among multiple
senders or meaningfully managing a receiver packet counter and window
in the context of multiple senders. However, EESP is capable to
handle packet counters among multiple senders. This can be done by
defining a new Base Header Option that covers a '<code>Sender ID</code>'.
Similar to the Session ID, this Sender ID can be used as an
additional Subs SA ID (see <a href="#sec-session-id-as-sub-sa-id" class="auto internal xref">Section 2.9</a>).
Defining such an Option is left for future documents.<a href="#section-2.3.1-1" class="pilcrow">¶</a></p>
<p id="section-2.3.1-2">Replay protection SHOULD be enabled.
However, on multicast or in datacenter environments where
the upper layer protocols ensure replay protection,
it can be disabled. Disabling replay protection MUST
be negotiated by IKEv2. In this case the sequence number
field is omitted.<a href="#section-2.3.1-2" class="pilcrow">¶</a></p>
<p id="section-2.3.1-3">In contrast to ESP, where the receiver alone decides wether to
disable replay protecton, it is negotiated in EESP so
that sender and receiver can agree on it.<a href="#section-2.3.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-2.3.2">
          <h4 id="name-initialization-vector">
<a href="#section-2.3.2" class="section-number selfRef">2.3.2. </a><a href="#name-initialization-vector" class="section-name selfRef">Initialization Vector</a>
          </h4>
<p id="section-2.3.2-1">If the algorithm used to encrypt the payload requires cryptographic
synchronization data, e.g., an Initialization Vector (IV), then this
data is carried explicitly in the '<code>Peer Header</code>' which is in front of
the encrypted part of the packet. Any encryption algorithm that requires
such explicit, per-packet synchronization data MUST indicate the
length, any structure for such data, and the location of this data as
part of an RFC specifying how the algorithm is used with EESP.
(Typically, the IV immediately precedes the ciphertext.  See Table 1)
If such synchronization data is implicit, the algorithm for deriving
the data MUST be part of the algorithm definition RFC.  (If included,
cryptographic synchronization data, e.g., an Initialization Vector
(IV), usually is not encrypted per se (see Table 1), although it
sometimes is referred to as being part of the ciphertext.)<a href="#section-2.3.2-1" class="pilcrow">¶</a></p>
<p id="section-2.3.2-2">Counter mode algorithms MAY use the 64-bit counter as the
Initialization Vector (IV) in the Sequence number Field, as specified
<span>[<a href="#RFC8750" class="cite xref">RFC8750</a>]</span>. This option, Implicit Initialization Vector (IIV)
saves the size of IV on each packet.
Whether or not this option is
selected is determined as part of Security Association (SA)
establishment.<a href="#section-2.3.2-2" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-2.4">
        <h3 id="name-payload-info-header">
<a href="#section-2.4" class="section-number selfRef">2.4. </a><a href="#name-payload-info-header" class="section-name selfRef">Payload Info Header</a>
        </h3>
<p id="section-2.4-1">The Payload Info Header is needed if the contained payload is
not a single IPv4 or IPv6 packet (e.g., when using Transport Mode,
BEET Mode <span>[<a href="#RFC7402" class="cite xref">RFC7402</a>]</span>, or IP-TFS <span>[<a href="#RFC9347" class="cite xref">RFC9347</a>]</span>). It is optional on
tunnel mode because this information can be derived from the inner
IPv4 or IPv6 header. This document specifies a full and an optimized
packet format. The Payload Info Header is present in the Full EESP
packet format, but not in the optimized format see
<a href="#sec-full-and-optimized-packet-formats" class="auto internal xref">Section 2.8</a>. IPsec peers and middleboxes
(if Crypt Offset is positive, see <a href="#sec-eesp-crypt-offset-option" class="auto internal xref">Section 3.1.3</a>) MAY
act upon the Payload Info Header.<a href="#section-2.4-1" class="pilcrow">¶</a></p>
<span id="name-payload-info-header-2"></span><div id="payload-info-header">
<figure id="figure-4">
          <div class="sourcecode" id="section-2.4-2.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  0x0  |        Reserved       | Next Header   | Pad Length    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-4" class="selfRef">Figure 4</a>:
<a href="#name-payload-info-header-2" class="selfRef">Payload Info Header</a>
          </figcaption></figure>
</div>
<section id="section-2.4.1">
          <h4 id="name-next-header">
<a href="#section-2.4.1" class="section-number selfRef">2.4.1. </a><a href="#name-next-header" class="section-name selfRef">Next Header</a>
          </h4>
<p id="section-2.4.1-1">The Next Header is an 8-bit field that identifies the type of data
contained in the Payload Data field, e.g., a next layer header and
data. The value of this field is chosen from the set of IP Protocol
Numbers defined on the web page of the IANA (e.g., a value of 6
indicates TCP and a value of 17 indicates UDP).<a href="#section-2.4.1-1" class="pilcrow">¶</a></p>
</section>
<section id="section-2.4.2">
          <h4 id="name-pad-length">
<a href="#section-2.4.2" class="section-number selfRef">2.4.2. </a><a href="#name-pad-length" class="section-name selfRef">Pad Length</a>
          </h4>
<p id="section-2.4.2-1">The Pad Length field indicates the number of pad bytes immediately
following the payload data and is used to align the ICV field. The
range of valid values is 0 to 255, where a value of zero indicates
that no Padding bytes are present.<a href="#section-2.4.2-1" class="pilcrow">¶</a></p>
</section>
</section>
<div id="sec-payload-data">
<section id="section-2.5">
        <h3 id="name-payload-data">
<a href="#section-2.5" class="section-number selfRef">2.5. </a><a href="#name-payload-data" class="section-name selfRef">Payload Data</a>
        </h3>
<p id="section-2.5-1">Payload Data is a variable-length field containing data from the
original IP packet.  The Payload
Data field is mandatory and is an integral number of bytes in length.<a href="#section-2.5-1" class="pilcrow">¶</a></p>
<p id="section-2.5-2">Note that the beginning of the next layer protocol header MUST be
aligned relative to the beginning of the EESP header as follows.  For
IPv4, this alignment is a multiple of 4 bytes.  For IPv6, the
alignment is a multiple of 8 bytes.<a href="#section-2.5-2" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-2.6">
        <h3 id="name-padding-for-encryption">
<a href="#section-2.6" class="section-number selfRef">2.6. </a><a href="#name-padding-for-encryption" class="section-name selfRef">Padding (for Encryption)</a>
        </h3>
<p id="section-2.6-1">Two primary factors require or motivate use of the Padding
field.<a href="#section-2.6-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-2.6-2.1">
            <p id="section-2.6-2.1.1">If an encryption algorithm is employed that requires the
plaintext to be a multiple of some number of bytes, e.g.,
the block size of a block cipher, the Padding field is used
to fill the plaintext (consisting of the Payload Data,
Padding, and Payload Info Header) to the size
required by the algorithm.<a href="#section-2.6-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-2.6-2.2">
            <p id="section-2.6-2.2.1">Padding also may be required, irrespective of encryption
algorithm requirements, to ensure that the resulting
ciphertext terminates on a 4-byte boundary to make sure
the ICV is properly aligned.<a href="#section-2.6-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-2.6-3">The sender MAY add 0 to 255 bytes of padding.  Inclusion of the
Padding field in an EESP packet is optional, subject to the
requirements noted above, but all implementations MUST support
generation and consumption of padding.<a href="#section-2.6-3" class="pilcrow">¶</a></p>
<p id="section-2.6-4">If Padding bytes are needed but the algorithm does not
specify the padding contents, then the Padding bytes
MUST be set to 0.<a href="#section-2.6-4" class="pilcrow">¶</a></p>
<p id="section-2.6-5">If an algorithm imposes constraints on
the values of the bytes used for padding, they MUST be specified by
the RFC defining how the algorithm is employed with EESP.  If the
algorithm requires checking of the values of the bytes used for
padding, this too MUST be specified in that RFC.<a href="#section-2.6-5" class="pilcrow">¶</a></p>
</section>
<section id="section-2.7">
        <h3 id="name-integrity-check-value-icv">
<a href="#section-2.7" class="section-number selfRef">2.7. </a><a href="#name-integrity-check-value-icv" class="section-name selfRef">Integrity Check Value (ICV)</a>
        </h3>
<p id="section-2.7-1">The Integrity Check Value is a variable-length field computed over
the Encrypted Payload and Additional Authenticated Data, as defined
in [ADD Construction]. The length of the field is specified by the
algorithm selected and associated with the SA. The algorithm
specification MUST specify the length of the ICV and the comparison
rules and processing steps for validation.<a href="#section-2.7-1" class="pilcrow">¶</a></p>
</section>
<div id="sec-full-and-optimized-packet-formats">
<section id="section-2.8">
        <h3 id="name-full-and-optimized-packet-f">
<a href="#section-2.8" class="section-number selfRef">2.8. </a><a href="#name-full-and-optimized-packet-f" class="section-name selfRef">Full and Optimized Packet Formats</a>
        </h3>
<p id="section-2.8-1">The resulting two packet formats are described in this section.
The default packet format for EESP is the full packet format.
When IPv4 or IPv6 tunnel mode is used, the '<code>Payload Info Header</code>' MAY
be omitted. Whether this option is chosen MUST be negotiated
by IKEv2, or any other suitable protocol.
In this optimized mode the payload will always start with
an IPv4 or IPv6 header. IPv4 or IPv6 packets always start with a
Version field at the first nibble, so it is possible to identify IPv4
and IPv6 by reading the first nibble of the inner packet, and there
is no need for a next header field. Additionally, IPv4 and IPv6 also
have a field describing the overall size of the inner packet, so a
pad length field is also not needed as it can be derived.<a href="#section-2.8-1" class="pilcrow">¶</a></p>
<p id="section-2.8-2">The packet format containing the '<code>Payload Info Header</code>' is called the
"Full EESP packet format", while the packet format without the
'<code>Payload Info Header</code>' is the called the "Optimized EESP packet format".
Which of these two formats are is encoded in the '<code>Packet Format</code>' bit in
the '<code>Base Header</code>'.<a href="#section-2.8-2" class="pilcrow">¶</a></p>
<p id="section-2.8-3">The two packet formats are shown below. <a href="#eesp-full-packet-format" class="auto internal xref">Figure 5</a>
shows the full packet format used as the default for modes of operation.
<a href="#eesp-optimized-packet-format" class="auto internal xref">Figure 6</a> illustrates the resulting optimized
packet format for use with IPv4 or IPv6 Tunnel Mode when the
'<code>Payload Info Header</code>' is elided.<a href="#section-2.8-3" class="pilcrow">¶</a></p>
<span id="name-full-eesp-packet-format"></span><div id="eesp-full-packet-format">
<figure id="figure-5">
          <div class="sourcecode" id="section-2.8-4.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|Version|Flags|    Opt Len    |        Session ID             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              SPI                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                   Options (variable, optional)                ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   Sequence Number (optional)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                          IV* (optional)                       ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  0x0  |        Reserved       | Next Header   | Pad Length    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   L4 Payload Data (variable)                  |
~                                                               ~
|               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               |          Padding (0-255 bytes)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-5" class="selfRef">Figure 5</a>:
<a href="#name-full-eesp-packet-format" class="selfRef">Full EESP packet format</a>
          </figcaption></figure>
</div>
<span id="name-optimized-eesp-packet-forma"></span><div id="eesp-optimized-packet-format">
<figure id="figure-6">
          <div class="sourcecode" id="section-2.8-5.1">
<pre>

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|1|Version|Flags|    Opt Len    |        Session ID             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                              SPI                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                   Options (variable, optional)                ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   Sequence Number (optional)                  |
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                          IV* (optional)                       ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~                     IPv4/IPv6 Header                          ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                   L4 Payload Data (variable)                  |
~                                                               ~
|               +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|               |          Padding (0-255 bytes)                |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-6" class="selfRef">Figure 6</a>:
<a href="#name-optimized-eesp-packet-forma" class="selfRef">Optimized EESP packet format</a>
          </figcaption></figure>
</div>
<p id="section-2.8-6">[*] If included, cryptographic synchronization data, e.g., an
'<code>Initialization Vector</code>' (IV), usually is not encrypted per se, although
it often is referred to as being part of the cipher-text. Unlike ESP,
the IV is not considered to be a part of the payload data in EESP.<a href="#section-2.8-6" class="pilcrow">¶</a></p>
<p id="section-2.8-7">The explicit IV shown in <a href="#eesp-packet-separate-algos" class="auto internal xref">Table 1</a> depends on the
used algorithm and may be omitted.  Because algorithms,
modes and options are fixed when an SA is established, the detailed
format of EESP packets for a given SA (including the '<code>Payload Data</code>'
substructure) is fixed for all traffic on the SA.<a href="#section-2.8-7" class="pilcrow">¶</a></p>
<p id="section-2.8-8">The table below refers to the fields in the preceding figures and
illustrate how several categories of algorithmic options, each with a
different processing model, affect the fields noted above.  The
processing details are described in later sections.<a href="#section-2.8-8" class="pilcrow">¶</a></p>
<span id="name-high-level-layout-for-field"></span><div id="eesp-packet-separate-algos">
<table class="center" id="table-1">
          <caption>
<a href="#table-1" class="selfRef">Table 1</a>:
<a href="#name-high-level-layout-for-field" class="selfRef">High level layout for fields of an EESP packet</a>
          </caption>
<thead>
            <tr>
              <th class="text-left" rowspan="1" colspan="1">Field</th>
              <th class="text-center" rowspan="1" colspan="1"># of bytes</th>
              <th class="text-center" rowspan="1" colspan="1">Req'd [1]</th>
              <th class="text-center" rowspan="1" colspan="1">Encrypt Covers</th>
              <th class="text-center" rowspan="1" colspan="1">Integ Covers</th>
              <th class="text-center" rowspan="1" colspan="1">Tx'd</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Base Header</td>
              <td class="text-center" rowspan="1" colspan="1">8</td>
              <td class="text-center" rowspan="1" colspan="1">M</td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">plain</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Options</td>
              <td class="text-center" rowspan="1" colspan="1">variable</td>
              <td class="text-center" rowspan="1" colspan="1">O</td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">plain</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Sequence Number</td>
              <td class="text-center" rowspan="1" colspan="1">8</td>
              <td class="text-center" rowspan="1" colspan="1">O</td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">plain</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">IV</td>
              <td class="text-center" rowspan="1" colspan="1">variable</td>
              <td class="text-center" rowspan="1" colspan="1">O</td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">plain</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Payload Info Hdr[4]</td>
              <td class="text-center" rowspan="1" colspan="1">4</td>
              <td class="text-center" rowspan="1" colspan="1">O</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">cipher [3]</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Payload [2]</td>
              <td class="text-center" rowspan="1" colspan="1">variable</td>
              <td class="text-center" rowspan="1" colspan="1">M</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">cipher [3]</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">Padding</td>
              <td class="text-center" rowspan="1" colspan="1">0-255</td>
              <td class="text-center" rowspan="1" colspan="1">M</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">Y</td>
              <td class="text-center" rowspan="1" colspan="1">cipher [3]</td>
            </tr>
            <tr>
              <td class="text-left" rowspan="1" colspan="1">ICV</td>
              <td class="text-center" rowspan="1" colspan="1">variable</td>
              <td class="text-center" rowspan="1" colspan="1">M</td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1"> </td>
              <td class="text-center" rowspan="1" colspan="1">plain</td>
            </tr>
          </tbody>
        </table>
</div>
<ul class="compact">
<li class="compact" id="section-2.8-10.1">
            <p id="section-2.8-10.1.1">[1] M = mandatory; O = optional<a href="#section-2.8-10.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact" id="section-2.8-10.2">
            <p id="section-2.8-10.2.1">[2] If tunnel mode -&gt; IP datagram. If BEET mode -&gt; IP datagram. If
transport mode -&gt; next header and data. If IP-TFS, IP-TFS header
and payload.<a href="#section-2.8-10.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact" id="section-2.8-10.3">
            <p id="section-2.8-10.3.1">[3] Ciphertext if encryption has been selected<a href="#section-2.8-10.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="compact" id="section-2.8-10.4">
            <p id="section-2.8-10.4.1">[4] Not present in Optimized Header otherwise mandatory<a href="#section-2.8-10.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-2.8-11">In the table "optional" means that the field is omitted if the option is not
selected, i.e., it is not present in the packet as transmitted
or as formatted for computation of an ICV. Whether or not an option
is selected is determined as part of Security Association (SA)
establishment. Thus, the format of EESP packets for a given SA is
fixed for the duration of the SA. In contrast, "mandatory" fields
are always present in the EESP packet format for all SAs.<a href="#section-2.8-11" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sec-session-id-as-sub-sa-id">
<section id="section-2.9">
        <h3 id="name-session-id-as-sub-sa-id">
<a href="#section-2.9" class="section-number selfRef">2.9. </a><a href="#name-session-id-as-sub-sa-id" class="section-name selfRef">Session ID as Sub SA ID</a>
        </h3>
<p id="section-2.9-1">This section specifies the use of the Session ID as a Sub SA ID.
The use of the Session ID as a Sub SA ID MUST be negotiated by IKEv2,
or any other suitable protocol. In this case, Session ID is used as a
16 bits Sub SA ID.
Sub SA IDs were initially defined in <span>[<a href="#I-D.ponchon-ipsecme-anti-replay-subspaces" class="cite xref">I-D.ponchon-ipsecme-anti-replay-subspaces</a>]</span>
and called '<code>Replay Subspaces</code>' there.<a href="#section-2.9-1" class="pilcrow">¶</a></p>
<p id="section-2.9-2">Each number of the 16 bits Sub SA ID encodes a single
64 bit anti-replay sequence number space.
This means that each core, path, or QoS class, or any combination of
those, can then use their own unique anti-replay sequence number subspace.
Each anti-replay sequence number subspace uses Sequence Numbers as
specified in section <a href="#sec-sequence-number" class="auto internal xref">Section 2.3.1</a>.<a href="#section-2.9-2" class="pilcrow">¶</a></p>
<p id="section-2.9-3">To make sure that at most 2^64 sequence numbers are used for a given key,
a KDF MUST be used used to derive a separate key for each anti-replay sequence
number subspace (see <a href="#sec-key-derivation-for-sub-sas" class="auto internal xref">Section 5</a>). In this case, the full
64 bits of each anti-replay sequence number subspace can be used.<a href="#section-2.9-3" class="pilcrow">¶</a></p>
<p id="section-2.9-4">Sub SAs can be created "on the fly" within the IPsec data-plane.
Sub SAs streamline traffic flow management, reduce overhead, and
enable more efficient lifecycle operations.<a href="#section-2.9-4" class="pilcrow">¶</a></p>
<p id="section-2.9-5">A pair of EESP SAs combined with multiple unidirectional Sub SAs
provides a more flexible approach to carrying  asymmetric traffic
patterns, particularly in high-speed environments.
Sub SAs reduces overhead, improves resource utilization, and enhances
scalability for large-scale deployments. In many use cases, several
unidirectional SAs used, while others are unused which can result
in unnecessary overhead for SA management, rekeying, and resource
consumption. Furthermore, using multiple bidirectional Child SAs for
granular traffic flows often leads to additional setup delays and
complex lifetime management. This inefficiency is particularly acute
in high-throughput or low-latency environments, where rapid setup and
teardown of SAs is essential to maintain performance.<a href="#section-2.9-5" class="pilcrow">¶</a></p>
<p id="section-2.9-6">Each Sub SA is identified by a Sub SA ID, which MUST be carried in
each EESP packet in the Session ID field—consistent with the
negotiation of the EESP Child SA. This Sub SA ID is used to derive a
unique key.<a href="#section-2.9-6" class="pilcrow">¶</a></p>
<p id="section-2.9-7">Particularly implementations with hardware offload, MAY derive Sub SA
keys dynamically on a per-packet basis. This mitigates the risk of
data-plane performance degradation caused by a large number of keys.<a href="#section-2.9-7" class="pilcrow">¶</a></p>
<p id="section-2.9-8">AEAD transforms such as AES-GCM <span>[<a href="#RFC4106" class="cite xref">RFC4106</a>]</span>, <span>[<a href="#RFC8750" class="cite xref">RFC8750</a>]</span> requires
that the IV never repeat within a single Sub SA. Because each
Sub SA uses a distinct key, the IV MAY be reused across different
Sub SAs, satisfying the requirement that each key be paired with a
unique IV. Implementations MUST also maintain an independent
sequence number space for each Sub SA when full 64-bit sequence
numbers are in use. For a given Sub SA key, sequence numbers MUST
remain unique and monotonically increasing to meet cryptographic
requirements.<a href="#section-2.9-8" class="pilcrow">¶</a></p>
<section id="section-2.9.1">
          <h4 id="name-sender-behavior">
<a href="#section-2.9.1" class="section-number selfRef">2.9.1. </a><a href="#name-sender-behavior" class="section-name selfRef">Sender Behavior</a>
          </h4>
<p id="section-2.9.1-1">This section defines the IPsec sender's behavior when transmitting
packets using an IPsec Child SA that has been previously configured or
negotiated with IKEv2 to use at most N different sequence number
subspace IDs.<a href="#section-2.9.1-1" class="pilcrow">¶</a></p>
<p id="section-2.9.1-2">The sender MAY set the sequence number subspace ID to any value
between 0 and N-1.  How the different subspace IDs are used is up to
the implementation, but as an example, the sender could use different
subspace ID values per path or per processing core (or combination of
both).<a href="#section-2.9.1-2" class="pilcrow">¶</a></p>
<p id="section-2.9.1-3">The sender MUST NOT use any subspace ID values greater or equal to N
(since the IPsec Child SA has been configured to use at most N different
values).  This requirement was introduced to improve the
implementation performance, as opposed to allowing the sender to use
arbitrary subspace ID values.<a href="#section-2.9.1-3" class="pilcrow">¶</a></p>
<p id="section-2.9.1-4">The sender MUST maintain one sequence number counter per sequence
number subspace that it makes use of.  But the sender MAY use only
some (and as few as a single one) of the available N subspace ID
values between 0 and N-1.<a href="#section-2.9.1-4" class="pilcrow">¶</a></p>
<p id="section-2.9.1-5">When transmitting a packet, the sender MUST use the sequence number
counter associated with the sequence number subspace in use for that
packet.<a href="#section-2.9.1-5" class="pilcrow">¶</a></p>
</section>
<section id="section-2.9.2">
          <h4 id="name-receiver-behavior">
<a href="#section-2.9.2" class="section-number selfRef">2.9.2. </a><a href="#name-receiver-behavior" class="section-name selfRef">Receiver Behavior</a>
          </h4>
<p id="section-2.9.2-1">This section defines the IPsec receiver's behavior when receiving
packets using an IPsec SA that has been previously configured or
negotiated to use at most N different sequence number subspace IDs.<a href="#section-2.9.2-1" class="pilcrow">¶</a></p>
<p id="section-2.9.2-2">The receiver MUST maintain one anti-replay window and counter for
each sequence number subspace being used.<a href="#section-2.9.2-2" class="pilcrow">¶</a></p>
<p id="section-2.9.2-3">When receiving a packet, the receiver MUST use the anti-replay window
and counter associated with the sequence number subspace identified
with the subspace ID field.<a href="#section-2.9.2-3" class="pilcrow">¶</a></p>
<p id="section-2.9.2-4">The receiver MUST drop any packet received with a subspace ID value
greater or equal to N. Receiving such packets is an auditable
event.  The audit log entry for this event SHOULD include the SPI value,
subspace ID value, current date/time, Source Address, Destination Address,
and (in IPv6) the cleartext Flow ID.<a href="#section-2.9.2-4" class="pilcrow">¶</a></p>
<p id="section-2.9.2-5">Note: Since the sender may decide to only use a subset of the
available N subspace values, the receiver MAY reactively allocate an
anti-replay window when receiving the first packet for a given
subspace.  When doing so, the receiver SHOULD first check the
authenticity of the packet before allocating the new anti-replay
window.<a href="#section-2.9.2-5" class="pilcrow">¶</a></p>
</section>
</section>
</div>
</section>
<div id="sec-eesp-header-options">
<section id="section-3">
      <h2 id="name-eesp-header-options">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-eesp-header-options" class="section-name selfRef">EESP Header Options</a>
      </h2>
<p id="section-3-1">The EESP header '<code>Options</code>' field carries a variable number of
type-length-value (TLV) encoded "options" of the following format:<a href="#section-3-1" class="pilcrow">¶</a></p>
<span id="name-eesp-header-option-format"></span><figure id="figure-7">
        <div class="sourcecode" id="section-3-2.1">
<pre>

+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -
|  Option Type  |  Opt Data Len |  Option Data
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -

</pre>
</div>
<figcaption><a href="#figure-7" class="selfRef">Figure 7</a>:
<a href="#name-eesp-header-option-format" class="selfRef">EESP Header Option Format</a>
        </figcaption></figure>
<span class="break"></span><dl class="dlParallel" id="section-3-3">
        <dt id="section-3-3.1">Option Type</dt>
        <dd style="margin-left: 1.5em" id="section-3-3.2">
          <p id="section-3-3.2.1">8-bit identifier of the type of option.<a href="#section-3-3.2.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-3-3.3">Opt Data Len</dt>
        <dd style="margin-left: 1.5em" id="section-3-3.4">
          <p id="section-3-3.4.1">8-bit unsigned integer.  Length of the Option Data
field of this option, in octets.<a href="#section-3-3.4.1" class="pilcrow">¶</a></p>
</dd>
        <dd class="break"></dd>
<dt id="section-3-3.5">Option Data</dt>
        <dd style="margin-left: 1.5em" id="section-3-3.6">
          <p id="section-3-3.6.1">Variable-length field. Option-Type-specific data.<a href="#section-3-3.6.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
<p id="section-3-4">The overall length of all Options is limited to 255 bytes by the
OptLen field in the '<code>Base Header</code>'.<a href="#section-3-4" class="pilcrow">¶</a></p>
<div id="sec-eesp-option-types">
<section id="section-3.1">
        <h3 id="name-eesp-option-types">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-eesp-option-types" class="section-name selfRef">EESP Option Types</a>
        </h3>
<p id="section-3.1-1">This document defines two padding options '<code>Pad1</code>' and '<code>PadN</code>', a '<code>Flow
Identifier Option</code>', and a '<code>Crypt Offset Option</code>'. Future documents can
define additional options. Appendix A of <span>[<a href="#RFC8200" class="cite xref">RFC8200</a>]</span> contains applicable
formatting guidelines for designing new options.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<section id="section-3.1.1">
          <h4 id="name-padding-options">
<a href="#section-3.1.1" class="section-number selfRef">3.1.1. </a><a href="#name-padding-options" class="section-name selfRef">Padding Options</a>
          </h4>
<p id="section-3.1.1-1">Individual options may have specific alignment requirements, to
ensure that multi-octet values within Option Data fields fall on
natural boundaries. The alignment requirement of an option is
specified using the notation xn+y, meaning the '<code>Option Type</code>' must
appear at an integer multiple of x octets from the start of the
'<code>Options</code>' field, plus y octets. For example:<a href="#section-3.1.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.1.1-2.1">
              <p id="section-3.1.1-2.1.1">2n means any 2-octet offset from the start of the '<code>Options</code>' field.<a href="#section-3.1.1-2.1.1" class="pilcrow">¶</a></p>
</li>
            <li class="normal" id="section-3.1.1-2.2">
              <p id="section-3.1.1-2.2.1">8n+2 means any 8-octet offset from the start of the '<code>Options</code>'
field, plus 2 octets.<a href="#section-3.1.1-2.2.1" class="pilcrow">¶</a></p>
</li>
          </ul>
<p id="section-3.1.1-3">Unless otherwise specified EESP options have no alignment
requirements.<a href="#section-3.1.1-3" class="pilcrow">¶</a></p>
<p id="section-3.1.1-4">There are two padding options which are used when necessary to align
subsequent options and to pad out the containing options field. These
padding options must be recognized by all implementations:<a href="#section-3.1.1-4" class="pilcrow">¶</a></p>
<section id="section-3.1.1.1">
            <h5 id="name-pad1-option">
<a href="#section-3.1.1.1" class="section-number selfRef">3.1.1.1. </a><a href="#name-pad1-option" class="section-name selfRef">Pad1 option</a>
            </h5>
<span id="name-pad1-option-2"></span><figure id="figure-8">
              <div class="sourcecode" id="section-3.1.1.1-1.1">
<pre>
+-+-+-+-+-+-+-+-+
|       0       |
+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-8" class="selfRef">Figure 8</a>:
<a href="#name-pad1-option-2" class="selfRef">Pad1 Option</a>
              </figcaption></figure>
<p id="section-3.1.1.1-2"><strong>Note:</strong> the format of the Pad1 option is a special case -- it does
not have length and value fields.<a href="#section-3.1.1.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1.1.1-3">The '<code>Pad1</code>' option is used to insert one octet of padding into the
Options field. If more than one octet of padding is required, the
'<code>PadN</code>' option, described next, should be used, rather than multiple
'<code>Pad1</code>' options.<a href="#section-3.1.1.1-3" class="pilcrow">¶</a></p>
</section>
<section id="section-3.1.1.2">
            <h5 id="name-padn-option">
<a href="#section-3.1.1.2" class="section-number selfRef">3.1.1.2. </a><a href="#name-padn-option" class="section-name selfRef">PadN option</a>
            </h5>
<span id="name-padn-option-2"></span><figure id="figure-9">
              <div class="sourcecode" id="section-3.1.1.2-1.1">
<pre>
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -
|       1       |  Opt Data Len |  Option Data
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+- - - - - - - - -
</pre>
</div>
<figcaption><a href="#figure-9" class="selfRef">Figure 9</a>:
<a href="#name-padn-option-2" class="selfRef">PadN Option</a>
              </figcaption></figure>
<p id="section-3.1.1.2-2">The '<code>PadN</code>' option is used to insert two or more octets of padding
into the '<code>Options</code>' field. For N octets of padding, the Opt Data Len
field contains the value N-2, and the '<code>Option Data</code>' consists of N-2
zero-valued octets.<a href="#section-3.1.1.2-2" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-3.1.2">
          <h4 id="name-eesp-flow-identifier-option">
<a href="#section-3.1.2" class="section-number selfRef">3.1.2. </a><a href="#name-eesp-flow-identifier-option" class="section-name selfRef">EESP Flow Identifier Option</a>
          </h4>
<p id="section-3.1.2-1">Flow Identifier (FID) Options are used to carry characteristic
information of the inner flow and SHOULD NOT change on per packet
basis inside any inner flow.<a href="#section-3.1.2-1" class="pilcrow">¶</a></p>
<p id="section-3.1.2-2">The Flow Identifier SHOULD be negotiated by IKEv2 or another
suitable protocol. The detailed specification of FIDs MAY be provided
in subsequent documents. The precise meaning of a FID is opaque to
intermediate devices.<a href="#section-3.1.2-2" class="pilcrow">¶</a></p>
<span id="name-flow-identifier-option"></span><div id="fid-option">
<figure id="figure-10">
            <div class="sourcecode" id="section-3.1.2-3.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Option Type  | Option Length |                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                               |
|                                                               |
~                    Flow Identifier (FID)                      ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-10" class="selfRef">Figure 10</a>:
<a href="#name-flow-identifier-option" class="selfRef">Flow Identifier Option</a>
            </figcaption></figure>
</div>
<span class="break"></span><dl class="dlParallel" id="section-3.1.2-4">
            <dt id="section-3.1.2-4.1">Option Type</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.2-4.2">
              <p id="section-3.1.2-4.2.1">8 bits: See <a href="#sec-eesp-header-options" class="auto internal xref">Section 3</a><a href="#section-3.1.2-4.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.2-4.3">Option Length</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.2-4.4">
              <p id="section-3.1.2-4.4.1">8 bits: See <a href="#sec-eesp-header-options" class="auto internal xref">Section 3</a><a href="#section-3.1.2-4.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.2-4.5">FID</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.2-4.6">
              <p id="section-3.1.2-4.6.1">Variable length, carries characteristic information of a
inner flow and MUST NOT change for a given inner flow within a SA.<a href="#section-3.1.2-4.6.1" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
</section>
<div id="sec-eesp-crypt-offset-option">
<section id="section-3.1.3">
          <h4 id="name-eesp-crypt-offset-option">
<a href="#section-3.1.3" class="section-number selfRef">3.1.3. </a><a href="#name-eesp-crypt-offset-option" class="section-name selfRef">EESP Crypt Offset Option</a>
          </h4>
<p id="section-3.1.3-1">This option is typically used within one Datacenter use case
such as <span>[<a href="#PSP" class="cite xref">PSP</a>]</span>. When enabled, full packet format with Payload Info
Header MUST be used; for the intermediate router to have Next Header.<a href="#section-3.1.3-1" class="pilcrow">¶</a></p>
<p id="section-3.1.3-2">The Crypt Offset can vary on a per packet basis. The maximum
allowed Crypt Offset MUST be negotiated by IKEv2 or any other
appropriate protocol. Packets with a Crypt Offset greater than
the negotiated maximum MUST be dropped by the receiver.
The receiver SHOULD cryptographically process such packets anyway.
The action in case of a correct ICV value depends on local policy.
However, it is recommended to tear down the connection as it can't be
considered as secure anymore.<a href="#section-3.1.3-2" class="pilcrow">¶</a></p>
<p id="section-3.1.3-3">Receiving such packets is an auditable event. The audit log entry for
this event SHOULD include the SPI value, subspace ID value, current
date/time, Source Address, Destination Address, and (in IPv6) the
cleartext Flow ID.<a href="#section-3.1.3-3" class="pilcrow">¶</a></p>
<p id="section-3.1.3-4">NOTE: This is for the use in Datacenters ONLY. It might be moved to
a separate document that defines the 'EESP use for Datacenters'.<a href="#section-3.1.3-4" class="pilcrow">¶</a></p>
<span id="name-crypt-offset-option"></span><div id="crypt-offset-option">
<figure id="figure-11">
            <div class="sourcecode" id="section-3.1.3-5.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Option Type  | Option Length |Payl.Offset|CryptOffset| R | F |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-11" class="selfRef">Figure 11</a>:
<a href="#name-crypt-offset-option" class="selfRef">Crypt Offset Option</a>
            </figcaption></figure>
</div>
<span class="break"></span><dl class="dlParallel" id="section-3.1.3-6">
            <dt id="section-3.1.3-6.1">Option Type</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.2">
              <p id="section-3.1.3-6.2.1">8 bits: See <a href="#sec-eesp-header-options" class="auto internal xref">Section 3</a><a href="#section-3.1.3-6.2.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.3-6.3">Option Length</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.4">
              <p id="section-3.1.3-6.4.1">8 bits: See <a href="#sec-eesp-header-options" class="auto internal xref">Section 3</a><a href="#section-3.1.3-6.4.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.3-6.5">Payload Offset</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.6">
              <p id="section-3.1.3-6.6.1">6 bits: The offset from the start of the fixed
header to the start of the payload header (or the payload for
optimized packet format) measured in 4-octet units.<a href="#section-3.1.3-6.6.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.3-6.7">CryptOffset</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.8">
              <p id="section-3.1.3-6.8.1">6 bits: The offset from the start of the payload
header (or the payload for optimized packet format) to the start of
the encrypted portion of the packet, measured in 4-octet units. The
resulting value MUST NOT be larger than the size of the inner
packet.<a href="#section-3.1.3-6.8.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.3-6.9">R[eserved]</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.10">
              <p id="section-3.1.3-6.10.1">2-bits: Reserved MUST be sent 0 and ignored on receipt.<a href="#section-3.1.3-6.10.1" class="pilcrow">¶</a></p>
</dd>
            <dd class="break"></dd>
<dt id="section-3.1.3-6.11">F[lags]</dt>
            <dd style="margin-left: 1.5em" id="section-3.1.3-6.12">
              <p id="section-3.1.3-6.12.1">2-bits: Flags used for stateless crypto signaling such as the
S-bit and D-bit in the PSP specification.<a href="#section-3.1.3-6.12.1" class="pilcrow">¶</a></p>
<p id="section-3.1.3-6.12.2"><strong>NOTE:</strong> I tend to remove the Flags if we keep the Crypt Offset
in this document, as we don't define PSP here.<a href="#section-3.1.3-6.12.2" class="pilcrow">¶</a></p>
</dd>
          <dd class="break"></dd>
</dl>
</section>
</div>
</section>
</div>
</section>
</div>
<section id="section-4">
      <h2 id="name-enhanced-encapsulating-secur">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-enhanced-encapsulating-secur" class="section-name selfRef">Enhanced Encapsulating Security Protocol Processing</a>
      </h2>
<section id="section-4.1">
        <h3 id="name-eesp-header-location">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-eesp-header-location" class="section-name selfRef">EESP Header Location</a>
        </h3>
<p id="section-4.1-1">EESP may be employed in multiple ways. To secure end-to-end
network traffic, transport mode may be used. For the VPN use case,
tunnel and BEET mode may be employed.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div id="sec-layer-4-encapsulation-modes">
<section id="section-4.1.1">
          <h4 id="name-layer-4-encapsulation-modes">
<a href="#section-4.1.1" class="section-number selfRef">4.1.1. </a><a href="#name-layer-4-encapsulation-modes" class="section-name selfRef">Layer 4 Encapsulation Modes</a>
          </h4>
<p id="section-4.1.1-1">Layer 4 Encapsulation Modes are transport mode and BEET mode
<span>[<a href="#RFC7402" class="cite xref">RFC7402</a>]</span> Layer 4 Encapsulation Modes
distinguish from tunnel mode on the position of the EESP
header in the packet. On Layer 4 Encapsulation Modes the
EESP header is inserted between the original IPv4/IPv6
header and the following Layer 4 header. In contrast to this,
in tunnel mode the full ipv4/IPv6 datagram is encapsulated.
This means the the EESP header is placed in front of the
original IPv4/IPv6 datagram and a new 'outer IPv4/IPv6 header'
is added in front of the EESP header. The following sections
illustrate the positioning of the EESP header<a href="#section-4.1.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1.1-2">Note that in Layer 4 Encapsulation Modes, for "bump-in-the-stack" or "bump-in-
the-wire" implementations, as defined in the Security Architecture
document, inbound and outbound IP fragments may require an IPsec
implementation to perform extra IP reassembly/fragmentation in order
to both conform to this specification and provide transparent IPsec
support.  Special care is required to perform such operations within
these implementations when multiple interfaces are in use.<a href="#section-4.1.1-2" class="pilcrow">¶</a></p>
<section id="section-4.1.1.1">
            <h5 id="name-transport-mode-processing">
<a href="#section-4.1.1.1" class="section-number selfRef">4.1.1.1. </a><a href="#name-transport-mode-processing" class="section-name selfRef">Transport Mode Processing</a>
            </h5>
<p id="section-4.1.1.1-1">In transport mode, EESP is inserted after the IP header and before a
next layer protocol, e.g., TCP, UDP, ICMP, etc.  In the context of
IPv4, this translates to placing EESP after the IP header (and any
options that it contains), but before the next layer protocol.  (If
AH is also applied to a packet, it is applied to the EESP header,
Payload and ICV, if present.)  (Note that the term
"transport" mode should not be misconstrued as restricting its use to
TCP and UDP.)  The following diagram illustrates EESP transport mode
positioning for a typical IPv4 packet, on a "before and after" basis.
(This and subsequent diagrams in this section show the ICV field, the
presence of which is a function of the security services and the
algorithm/mode selected.)<a href="#section-4.1.1.1-1" class="pilcrow">¶</a></p>
<span id="name-ipv4-transport-mode"></span><div id="ipv4-transport-mode">
<figure id="figure-12">
              <div class="sourcecode" id="section-4.1.1.1-2.1">
<pre>
           BEFORE APPLYING EESP
      ----------------------------
IPv4  |orig IP hdr  |     |      |
      |(any options)| TCP | Data |
      ----------------------------

           AFTER APPLYING EESP
      ---------------------------------------------------
IPv4  |orig IP hdr  | EESP |     |               | EESP |
      |(any options)| Hdr  | TCP | L4 pyld Data  | ICV  |
      ---------------------------------------------------
                           |&lt;---- encryption ---&gt;|
                    |&lt;-------- integrity -------&gt;|
</pre>
</div>
<figcaption><a href="#figure-12" class="selfRef">Figure 12</a>:
<a href="#name-ipv4-transport-mode" class="selfRef">IPv4 Transport Mode</a>
              </figcaption></figure>
</div>
<p id="section-4.1.1.1-3">In the IPv6 context, EESP is viewed as an end-to-end payload, and thus
should appear after hop-by-hop, routing, and fragmentation extension
headers.  Destination options extension header(s) could appear
before, after, or both before and after the EESP header depending on
the semantics desired.  However, because EESP protects only fields
after the EESP header, it generally will be desirable to place the
destination options header(s) after the EESP header.  The following
diagram illustrates EESP transport mode positioning for a typical IPv6
packet.<a href="#section-4.1.1.1-3" class="pilcrow">¶</a></p>
<span id="name-ipv6-transport-mode"></span><div id="ipv6-transport-mode">
<figure id="figure-13">
              <div class="sourcecode" id="section-4.1.1.1-4.1">
<pre>

               BEFORE APPLYING EESP
      ---------------------------------------
IPv6  |             | ext hdrs |     |      |
      | orig IP hdr |if present| TCP | Data |
      ---------------------------------------

               AFTER APPLYING EESP
      ----------------------------------------------------------
IPv6  | orig |hop-by-hop,dest*,|EESP|dest|   |   Layer 4  |EESP|
      |IP hdr|routing,fragment.|Hdr |opt*|TCP|Payload Data|ICV |
      ----------------------------------------------------------
                                    |&lt;--- encryption ----&gt;|
                               |&lt;------ integrity -------&gt;|

          * = if present, could be before EESP, after EESP, or both
</pre>
</div>
<figcaption><a href="#figure-13" class="selfRef">Figure 13</a>:
<a href="#name-ipv6-transport-mode" class="selfRef">IPv6 Transport Mode</a>
              </figcaption></figure>
</div>
</section>
<section id="section-4.1.1.2">
            <h5 id="name-beet-mode-processing">
<a href="#section-4.1.1.2" class="section-number selfRef">4.1.1.2. </a><a href="#name-beet-mode-processing" class="section-name selfRef">BEET Mode Processing</a>
            </h5>
<p id="section-4.1.1.2-1">In BEET mode, EESP is inserted exactly at the same position
as it is done for transport mode. The original IP or IPv6 header
is replaced by a new one. The new header SHOULD be negotiated by IKEv2
or any other suitable protocol.<a href="#section-4.1.1.2-1" class="pilcrow">¶</a></p>
<span id="name-ipv6-beet-mode"></span><div id="ipv4-beet-mode">
<figure id="figure-14">
              <div class="sourcecode" id="section-4.1.1.2-2.1">
<pre>
           BEFORE APPLYING EESP
      ----------------------------
IPv4  |orig IP hdr  |     |      |
      |(any options)| TCP | Data |
      ----------------------------

           AFTER APPLYING EESP
      ---------------------------------------------------
IPv4  | new IP hdr  | EESP |     |               | EESP |
      |(any options)| Hdr  | TCP | L4 pyld Data  | ICV  |
      ---------------------------------------------------
                           |&lt;---- encryption ---&gt;|
                    |&lt;-------- integrity -------&gt;|
</pre>
</div>
<figcaption><a href="#figure-14" class="selfRef">Figure 14</a>:
<a href="#name-ipv6-beet-mode" class="selfRef">IPv6 BEET Mode</a>
              </figcaption></figure>
</div>
<span id="name-ipv6-beet-mode-2"></span><div id="ipv6-beet-mode">
<figure id="figure-15">
              <div class="sourcecode" id="section-4.1.1.2-3.1">
<pre>

               BEFORE APPLYING EESP
      ---------------------------------------
IPv6  |             | ext hdrs |     |      |
      | orig IP hdr |if present| TCP | Data |
      ---------------------------------------

               AFTER APPLYING EESP
      ----------------------------------------------------------
IPv6  | new  |hop-by-hop,dest*,|EESP|dest|   |   Layer 4  |EESP|
      |IP hdr|routing,fragment.|Hdr |opt*|TCP|Payload Data|ICV |
      ----------------------------------------------------------
                                    |&lt;--- encryption ----&gt;|
                               |&lt;------ integrity -------&gt;|

          * = if present, could be before EESP, after EESP, or both
</pre>
</div>
<figcaption><a href="#figure-15" class="selfRef">Figure 15</a>:
<a href="#name-ipv6-beet-mode-2" class="selfRef">IPv6 BEET Mode</a>
              </figcaption></figure>
</div>
</section>
</section>
</div>
<section id="section-4.1.2">
          <h4 id="name-tunnel-mode-processing">
<a href="#section-4.1.2" class="section-number selfRef">4.1.2. </a><a href="#name-tunnel-mode-processing" class="section-name selfRef">Tunnel Mode Processing</a>
          </h4>
<p id="section-4.1.2-1">In tunnel mode, the "inner" IP header carries the ultimate (IP)
source and destination addresses, while an "outer" IP header contains
the addresses of the IPsec "peers", e.g., addresses of security
gateways.  Mixed inner and outer IP versions are allowed, i.e., IPv6
over IPv4 and IPv4 over IPv6.  In tunnel mode, EESP protects the
entire inner IP packet, including the entire inner IP header.  The
position of EESP in tunnel mode, relative to the outer IP header, is
the same as for EESP in transport mode.  The following diagram
illustrates EESP tunnel mode positioning for typical IPv4 and IPv6
packets.<a href="#section-4.1.2-1" class="pilcrow">¶</a></p>
<span id="name-ipv4-tunnel-mode"></span><div id="ipv4-tunnel-mode">
<figure id="figure-16">
            <div class="sourcecode" id="section-4.1.2-2.1">
<pre>
           BEFORE APPLYING ESP
      ----------------------------
IPv4  |orig IP hdr  |     |      |
      |(any options)| TCP | Data |
      ----------------------------

           AFTER APPLYING ESP

      ----------------------------------------------------------
IPv4  | new IP hdr* | EESP | orig IP hdr*  |     |      | EESP |
      |(any options)| Hdr  | (any options) | TCP | Data | ICV  |
      ----------------------------------------------------------
                           |&lt;------- encryption -------&gt;|
                    |&lt;------------ integrity ----------&gt;|

</pre>
</div>
<figcaption><a href="#figure-16" class="selfRef">Figure 16</a>:
<a href="#name-ipv4-tunnel-mode" class="selfRef">IPv4 Tunnel Mode</a>
            </figcaption></figure>
</div>
<span id="name-ipv6-tunnel-mode"></span><div id="ipv6-tunnel-mode">
<figure id="figure-17">
            <div class="sourcecode" id="section-4.1.2-3.1">
<pre>
                BEFORE APPLYING ESP
      ---------------------------------------
IPv6  |             | ext hdrs |     |      |
      | orig IP hdr |if present| TCP | Data |
      ---------------------------------------

               AFTER APPLYING ESP

      --------------------------------------------------------------
IPv6  | new* |new ext | EESP | orig*| orig ext |     |      | EESP |
      |IP hdr| hdrs*  | Hdr  |IP hdr|  hdrs *  | TCP | Data | ICV  |
      --------------------------------------------------------------
                             |&lt;-------- encryption --------&gt;|
                      |&lt;------------ integrity ------------&gt;|

      * = if present, construction of outer IP hdr/extensions and
          modification of inner IP hdr/extensions is discussed in
          the Security Architecture document.
</pre>
</div>
<figcaption><a href="#figure-17" class="selfRef">Figure 17</a>:
<a href="#name-ipv6-tunnel-mode" class="selfRef">IPv6 Tunnel Mode</a>
            </figcaption></figure>
</div>
</section>
</section>
<div id="sec-aad-construction">
<section id="section-4.2">
        <h3 id="name-aad-construction">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-aad-construction" class="section-name selfRef">AAD Construction</a>
        </h3>
<p id="section-4.2-1">Additional Authenticated Data (AAD) includes the Base
Header, any Optional Headers and Peer Header.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<span id="name-eesp-aad"></span><div id="eesp-aad">
<figure id="figure-18">
          <div class="sourcecode" id="section-4.2-2.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|                                                               |  |
~                          Base Header                          ~  |
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Int
|                                                               | egr
~                     Peer Header (variable)                    ~ ity
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Pro
|                                                               | tec
~                Encrypted Payload Data (variable)              ~ ted
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-18" class="selfRef">Figure 18</a>:
<a href="#name-eesp-aad" class="selfRef">EESP AAD</a>
          </figcaption></figure>
</div>
<p id="section-4.2-3">Additionally, if a Crypt Offset is used, the AAD includes the
associated data exposed due to the offset. Payload Data covered
by the Crypt Offset is transmitted in the clear, but is still
included in the AAD.<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<span id="name-eesp-tunnel-mode-aad-with-c"></span><div id="eesp-aad-crypt-offset">
<figure id="figure-19">
          <div class="sourcecode" id="section-4.2-4.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|                                                               |  |
~                          Base Header                          ~  |
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  |
|                 Crypt Offset Optional Header                  |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Int
|                                                               | egr
~                     Peer Header (variable)                    ~ ity
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Pro
|                  Plaintext Payload Data (variable)            | tec
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ ted
|                                                               |  |
~                    Encrypted Payload Data (variable)          ~  |
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-19" class="selfRef">Figure 19</a>:
<a href="#name-eesp-tunnel-mode-aad-with-c" class="selfRef">EESP Tunnel Mode AAD with Crypt Offset</a>
          </figcaption></figure>
</div>
<p id="section-4.2-5">As an example consider a Tunnel mode SA, with replay protection
enabled and 8 bytes explicit IV carrying an IPv4 UDP packet with
Crypt Offset 8 (8x4 = 32 bytes). <a href="#eesp-aad-crypt-offset-example" class="auto internal xref">Figure 20</a><a href="#section-4.2-5" class="pilcrow">¶</a></p>
<span id="name-eesp-tunnel-mode-aad-with-cr"></span><div id="eesp-aad-crypt-offset-example">
<figure id="figure-20">
          <div class="sourcecode" id="section-4.2-6.1">
<pre>
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|1|Version|Flags|   Opt Len (4) |         Session ID            |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  |
|                              SPI                              |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  |
|  Crypt Offset(2)  |Opt Len (4)|POffset (7)|CryptOff(8)| F | R |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ Int
|                       Sequence number 63-32                   | egr
|                       Sequence number 31-0                    | ity
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  |
|                           IV 63-32                            | Pro
|                           IV 31-0                             | tec
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ ted
|           Payload Info Header (Next header 4) Plain text)     |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  |
|               IPv4 + UDP Headers 28 bytes Plain text          |  |
+---------------------------------------------------------------+  |
|                                                               |  |
~                Remaining Encrypted Payload Data               ~  |
|                                                               |  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+--+
|                                                               |
~              Integrity Check Value-ICV (variable)             ~
|                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
</pre>
</div>
<figcaption><a href="#figure-20" class="selfRef">Figure 20</a>:
<a href="#name-eesp-tunnel-mode-aad-with-cr" class="selfRef">EESP Tunnel Mode AAD with Crypt Offset example</a>
          </figcaption></figure>
</div>
<p id="section-4.2-7">The AAD specifications apply to all EESP cipher suites used with
EESP. This document updates <span>[<a href="#RFC4106" class="cite xref">RFC4106</a>]</span> to define EESP-specific
handling of Additional Authenticated Data (AAD) when using
AES-GCM. For AES-GMAC <span>[<a href="#RFC4543" class="cite xref">RFC4543</a>]</span>, the AAD includes all headers,
i.e. the entire EESP payload except the Integrity Check Value (ICV).
This document also updates AAD processing for the
ENCR_CHACHA20_POLY1305 cipher suite, as specified in <span>[<a href="#RFC7634" class="cite xref">RFC7634</a>]</span>.<a href="#section-4.2-7" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-4.3">
        <h3 id="name-algorithms">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-algorithms" class="section-name selfRef">Algorithms</a>
        </h3>
<p id="section-4.3-1">EESP version 0 specifies combined mode algorithms only. Separate
confidentiality and integrity algorithms MUST NOT be used with
version 0 of EESP. This means that both, confidentiality and
integrity services are provided always.
Although not specified here, EESP can support
separate confidentiality and integrity algorithms. In case
using separate confidentiality and integrity algorithms becomes
necessary, a new version of EESP MUST be defined.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<p id="section-4.3-2">The mandatory-to-implement algorithms for use with EESP described
in a separate RFC, for e.g. RFC8221bis or another I.D., to facilitate
updating the algorithm requirements independently from the protocol
per se.  Additional algorithms, beyond those mandated for EESP, MAY
be supported.<a href="#section-4.3-2" class="pilcrow">¶</a></p>
<section id="section-4.3.1">
          <h4 id="name-combined-mode-algorithms">
<a href="#section-4.3.1" class="section-number selfRef">4.3.1. </a><a href="#name-combined-mode-algorithms" class="section-name selfRef">Combined Mode Algorithms</a>
          </h4>
<p id="section-4.3.1-1">The combined mode algorithm employed to protect an EESP packet is
specified by the SA via which the packet is transmitted/received.
Because IP packets may arrive out of order, and not all packets may
arrive (packet loss), each packet must carry any data required to
allow the receiver to establish cryptographic synchronization for
decryption.  This data may be carried explicitly, e.g., as an
IV (as described above), or the data may be
derived from the plaintext portions of the (outer IP or EESP) packet
header.  (Note that if plaintext header information is used to derive
an IV, that information may become security critical and thus the
protection boundary associated with the encryption process may grow.<a href="#section-4.3.1-1" class="pilcrow">¶</a></p>
<p id="section-4.3.1-2">For example, if one were to use the EESP Sequence Number to derive an
IV, the Sequence Number generation logic (hardware or software) would
have to be evaluated as part of the encryption algorithm
implementation.  In the case of FIPS 140-2 <span>[<a href="#NIST01" class="cite xref">NIST01</a>]</span>, this could
significantly extend the scope of a cryptographic module evaluation.)<a href="#section-4.3.1-2" class="pilcrow">¶</a></p>
<p id="section-4.3.1-3">Because EESP makes provision for padding of the plaintext, combined mode
algorithms employed with EESP may exhibit either block or stream mode
characteristics.  The means
by which a combined mode algorithm provides integrity for the
payload, and for the header fields, may
vary for different algorithm choices.  In order to provide a uniform,
algorithm-independent approach to invocation of combined mode
algorithms, no payload substructure is defined.<a href="#section-4.3.1-3" class="pilcrow">¶</a></p>
<p id="section-4.3.1-4">To allow an EESP implementation to determine the MTU impact of a
combined mode algorithm, the RFC for each algorithm used with EESP
must specify a (simple) formula that yields encrypted payload size,
as a function of the plaintext payload and EESP header sizes.<a href="#section-4.3.1-4" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-4.4">
        <h3 id="name-outbound-packet-processing">
<a href="#section-4.4" class="section-number selfRef">4.4. </a><a href="#name-outbound-packet-processing" class="section-name selfRef">Outbound Packet Processing</a>
        </h3>
<p id="section-4.4-1">In Layer 4 Encapsulation Modes, the sender encapsulates the next
layer protocol information behind the EESP header fields, and
retains the specified IP header (and any IP extension headers in the
IPv6 context).  In tunnel mode, the outer and inner IP
header/extensions can be interrelated in a variety of ways.  The
construction of the outer IP header/extensions during the
encapsulation process is described in the Security Architecture
document.<a href="#section-4.4-1" class="pilcrow">¶</a></p>
<section id="section-4.4.1">
          <h4 id="name-security-association-lookup">
<a href="#section-4.4.1" class="section-number selfRef">4.4.1. </a><a href="#name-security-association-lookup" class="section-name selfRef">Security Association Lookup</a>
          </h4>
<p id="section-4.4.1-1">EESP is applied to an outbound packet only after an IPsec
implementation determines that the packet is associated with an SA
that calls for EESP processing.  The process of determining what, if
any, IPsec processing is applied to outbound traffic is described in
the Security Architecture document.<a href="#section-4.4.1-1" class="pilcrow">¶</a></p>
</section>
<div id="sec-packet-encryption-and-integrity-check-value-icv-calculation">
<section id="section-4.4.2">
          <h4 id="name-packet-encryption-and-integ">
<a href="#section-4.4.2" class="section-number selfRef">4.4.2. </a><a href="#name-packet-encryption-and-integ" class="section-name selfRef">Packet Encryption and Integrity Check Value (ICV) Calculation</a>
          </h4>
<p id="section-4.4.2-1">In this section, we speak in terms of encryption always being applied
because of the formatting implications.  This is done with the
understanding that "no confidentiality" is offered, for instance,
by using the AES-CMAC algorithm (<span>[<a href="#RFC4494" class="cite xref">RFC4494</a>]</span>).<a href="#section-4.4.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-4.4.3">
          <h4 id="name-combined-confidentiality-an">
<a href="#section-4.4.3" class="section-number selfRef">4.4.3. </a><a href="#name-combined-confidentiality-an" class="section-name selfRef">Combined Confidentiality and Integrity Algorithms</a>
          </h4>
<p id="section-4.4.3-1">The Sender proceeds for combined confidentiality/integrity algorithm as follows:<a href="#section-4.4.3-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.4.3-2">
<li id="section-4.4.3-2.1">
              <p id="section-4.4.3-2.1.1">Encapsulate into the EESP Payload Data field:<a href="#section-4.4.3-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.4.3-2.1.2.1">
                  <p id="section-4.4.3-2.1.2.1.1">for transport and BEET mode -- just the original next layer
protocol information.<a href="#section-4.4.3-2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.3-2.1.2.2">
                  <p id="section-4.4.3-2.1.2.2.1">for tunnel mode -- the entire original IP datagram.<a href="#section-4.4.3-2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
            <li id="section-4.4.3-2.2">
              <p id="section-4.4.3-2.2.1">Add any necessary (encryption) Padding.<a href="#section-4.4.3-2.2.1" class="pilcrow">¶</a></p>
</li>
            <li id="section-4.4.3-2.3">
              <p id="section-4.4.3-2.3.1">Encrypt and integrity protect the result using the key
and combined mode algorithm specified for the SA and using
any required cryptographic synchronization data.<a href="#section-4.4.3-2.3.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.4.3-2.3.2.1">
                  <p id="section-4.4.3-2.3.2.1.1">If explicit cryptographic synchronization data,
e.g., an IV, is indicated, it is input to the
combined mode algorithm per the algorithm
specification and placed in the IV field of the peer header.<a href="#section-4.4.3-2.3.2.1.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.3-2.3.2.2">
                  <p id="section-4.4.3-2.3.2.2.1">If implicit cryptographic synchronization data is
employed, it is constructed and input to the
encryption algorithm as per the algorithm
specification.<a href="#section-4.4.3-2.3.2.2.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.3-2.3.2.3">
                  <p id="section-4.4.3-2.3.2.3.1">The EESP header fields are inputs to the
algorithm, as they must be included in the integrity
check computation.  The means by which these values
are included in this computation are a function of
the combined mode algorithm employed.<a href="#section-4.4.3-2.3.2.3.1" class="pilcrow">¶</a></p>
</li>
                <li class="normal" id="section-4.4.3-2.3.2.4">
                  <p id="section-4.4.3-2.3.2.4.1">The (explicit) ICV field MAY be a part of the EESP
packet format. If one is not used, an analogous field
usually will be a part of the ciphertext payload.
The location of any integrity fields, and the means
by which the EESP header fields are included in
the integrity computation, are defined in <a href="#sec-aad-construction" class="auto internal xref">Section 4.2</a>.<a href="#section-4.4.3-2.3.2.4.1" class="pilcrow">¶</a></p>
</li>
              </ul>
</li>
          </ol>
</section>
<section id="section-4.4.4">
          <h4 id="name-sequence-number-generation">
<a href="#section-4.4.4" class="section-number selfRef">4.4.4. </a><a href="#name-sequence-number-generation" class="section-name selfRef">Sequence Number Generation</a>
          </h4>
<p id="section-4.4.4-1">Replay protection is negotiated by the IPsec peers. If
a SA chooses to do replay protection, the sequence numbers
are generated in the following way.<a href="#section-4.4.4-1" class="pilcrow">¶</a></p>
<p id="section-4.4.4-2">The sender's counter SHOULD be initialized to 0 when an SA is established.
The sender increments the sequence number counter for this
SA and inserts this value into the Sequence Number field of the Peer Header.
Note that 0 is not a valid sequence number. Thus, the minimal sequence
number to use for the first packet sent using given SA 1. This means that
the first packet sent using given SA will contain a sequence number of 1,
or bigger. The most natural method to increase the sequence number
is to increase only by one for each sent packet. This method SHOULD
be implemented when possible. However, peers MAY choose different
replay protection algorithms, i.e. not by using sequence numbers
that are incremented by one for each packet. In case the peers choose
such an algorithm, the sender MUST ensure that the sequence
number is strictly monotonic increasing.<a href="#section-4.4.4-2" class="pilcrow">¶</a></p>
<p id="section-4.4.4-3">The sender checks to ensure
that the counter has not cycled before inserting the new value in the
Sequence Number field.  In other words, the sender MUST NOT send a
packet on such an SA. If doing so would cause the sequence number to cycle.
An attempt to transmit a packet that would result in sequence number
overflow is an auditable event.  The audit log entry for this event
SHOULD include the SPI value, Session ID value, current date/time,
Source Address, Destination Address, and (in IPv6) the cleartext Flow ID.<a href="#section-4.4.4-3" class="pilcrow">¶</a></p>
<p id="section-4.4.4-4">Typical behavior of an EESP implementation calls for the sender to
establish a new SA when the Sequence Number of the SA cycles, or if
sequence number subspaces are used any one of the subspaces cycles,
or in anticipation of this values cycling.<a href="#section-4.4.4-4" class="pilcrow">¶</a></p>
<p id="section-4.4.4-5">If the key used to compute an ICV is manually distributed, a
compliant implementation SHOULD NOT provide anti-replay service.  If
a user chooses to employ anti-replay in conjunction with SAs that are
manually keyed, the sequence number counter at the sender MUST be
correctly maintained across local reboots, etc., until the key is
replaced.<a href="#section-4.4.4-5" class="pilcrow">¶</a></p>
</section>
<section id="section-4.4.5">
          <h4 id="name-fragmentation">
<a href="#section-4.4.5" class="section-number selfRef">4.4.5. </a><a href="#name-fragmentation" class="section-name selfRef">Fragmentation</a>
          </h4>
<p id="section-4.4.5-1">If necessary, fragmentation is performed after EESP processing within
an IPsec implementation.  Thus, transport and BEET mode, EESP is applied only to
whole IP datagrams (not to IP fragments).  An IP packet to which EESP
has been applied may itself be fragmented by routers en route, and
such fragments must be reassembled prior to EESP processing at a
receiver.  In tunnel mode, EESP is applied to an IP packet, which may
be a fragment of an IP datagram.  For example, a security gateway or
a "bump-in-the-stack" or "bump-in-the-wire" IPsec implementation (as
defined in the Security Architecture document) may apply tunnel mode
EESP to such fragments.<a href="#section-4.4.5-1" class="pilcrow">¶</a></p>
<p id="section-4.4.5-2">NOTE: For Layer 4 Encapsulation Modes -- As mentioned at the end of
<a href="#sec-layer-4-encapsulation-modes" class="auto internal xref">Section 4.1.1</a>,
bump-in-the-stack and bump-in-the-wire implementations may have to
first reassemble a packet fragmented by the local IP layer, then
apply IPsec, and then fragment the resulting packet.<a href="#section-4.4.5-2" class="pilcrow">¶</a></p>
<p id="section-4.4.5-3">NOTE: For IPv6 -- For bump-in-the-stack and bump-in-the-wire
implementations, it will be necessary to examine all the extension
headers to determine if there is a fragmentation header and hence
that the packet needs reassembling prior to IPsec processing.<a href="#section-4.4.5-3" class="pilcrow">¶</a></p>
<p id="section-4.4.5-4">Fragmentation, whether performed by an IPsec implementation or by
routers along the path between IPsec peers, significantly reduces
performance.  Moreover, the requirement for an EESP receiver to accept
fragments for reassembly creates denial of service vulnerabilities.
Thus, an EESP implementation MAY choose to not support fragmentation
and may mark transmitted packets with the DF bit, to facilitate Path
MTU (PMTU) discovery.  In any case, an EESP implementation MUST
support generation of ICMP PMTU messages (or equivalent internal
signaling for native host implementations) to minimize the likelihood
of fragmentation.  Details of the support required for MTU management
are contained in the Security Architecture document.<a href="#section-4.4.5-4" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-4.5">
        <h3 id="name-inbound-packet-processing">
<a href="#section-4.5" class="section-number selfRef">4.5. </a><a href="#name-inbound-packet-processing" class="section-name selfRef">Inbound Packet Processing</a>
        </h3>
<section id="section-4.5.1">
          <h4 id="name-reassembly">
<a href="#section-4.5.1" class="section-number selfRef">4.5.1. </a><a href="#name-reassembly" class="section-name selfRef">Reassembly</a>
          </h4>
<p id="section-4.5.1-1">If required, reassembly is performed prior to EESP processing.  If a
packet offered to EESP for processing appears to be an IP fragment,
i.e., the OFFSET field is non-zero or the MORE FRAGMENTS flag is set,
the receiver MUST discard the packet; this is an auditable event.
The audit log entry for this event SHOULD include the SPI value,
Session ID value, date/time received, Source Address, Destination
Address, Sequence Number, and (in IPv6) the Flow ID.<a href="#section-4.5.1-1" class="pilcrow">¶</a></p>
<p id="section-4.5.1-2">NOTE: For packet reassembly, the current IPv4 spec does NOT require
either the zeroing of the OFFSET field or the clearing of the MORE
FRAGMENTS flag.  In order for a reassembled packet to be processed by
IPsec (as opposed to discarded as an apparent fragment), the IP code
must do these two things after it reassembles a packet.<a href="#section-4.5.1-2" class="pilcrow">¶</a></p>
</section>
<section id="section-4.5.2">
          <h4 id="name-security-association-lookup-2">
<a href="#section-4.5.2" class="section-number selfRef">4.5.2. </a><a href="#name-security-association-lookup-2" class="section-name selfRef">Security Association Lookup</a>
          </h4>
<p id="section-4.5.2-1">Upon receipt of a packet containing an EESP Header, the receiver
determines the appropriate (unidirectional) SA via lookup in the SAD.
For a unicast SA, this determination is based on the SPI or the SPI
plus protocol field, as described in Section 2.1.  If an
implementation supports multicast traffic, the destination address is
also employed in the lookup (in addition to the SPI), and the sender
address also may be employed, as described in Section 2.1.  (This
process is described in more detail in the Security Architecture
document.)  The SAD entry for the SA also indicates whether the
Sequence Number field is present, and whether the (explicit) ICV field
should be present (and if so, its size).  Also, the SAD entry will
specify the algorithms and keys to be employed for decryption and ICV
computation (if applicable).<a href="#section-4.5.2-1" class="pilcrow">¶</a></p>
<p id="section-4.5.2-2">If no valid Security Association exists for this packet, the receiver
MUST discard the packet; this is an auditable event.  The audit log
entry for this event SHOULD include the SPI value, Session ID value,
date/time received, Source Address, Destination Address, Sequence Number,
and (in IPv6) the cleartext Flow ID.<a href="#section-4.5.2-2" class="pilcrow">¶</a></p>
</section>
<section id="section-4.5.3">
          <h4 id="name-sequence-number-verificatio">
<a href="#section-4.5.3" class="section-number selfRef">4.5.3. </a><a href="#name-sequence-number-verificatio" class="section-name selfRef">Sequence Number Verification</a>
          </h4>
<p id="section-4.5.3-1">All EESP implementations MUST support the anti-replay service, though
its use may be enabled or disabled by negotiation on a per-SA basis.
Anti-replay is applicable to unicast as well as multicast SAs.<a href="#section-4.5.3-1" class="pilcrow">¶</a></p>
<p id="section-4.5.3-2">However, this standard specifies
no mechanisms for providing anti-replay for a multi-sender SA
(unicast or multicast).  In the absence of negotiation (or manual
configuration) of an anti-replay mechanism for such an SA, it is
recommended that sender and receiver checking of the sequence number
for the SA be disabled (via negotiation or manual configuration), as
noted below.<a href="#section-4.5.3-2" class="pilcrow">¶</a></p>
<p id="section-4.5.3-3">If anti-replay service is enabled for this SA, the
receive packet counter for each used Sub SA MUST be initialized to zero when
the SA is established.  For each received packet on a Sub SA, the receiver MUST
verify that the packet contains a Sequence Number that does not
duplicate the Sequence Number of any other packets received on this Sub SA during
the life of the SA.  This SHOULD be the first ESP check applied to a
packet after it has been matched to an SA, to speed rejection of
duplicate packets.<a href="#section-4.5.3-3" class="pilcrow">¶</a></p>
<p id="section-4.5.3-4">EESP permits two-stage verification of packet sequence numbers.  This
capability is important whenever an ESP implementation (typically the
cryptographic module portion thereof) is not capable of performing
decryption and/or integrity checking at the same rate as the
interface(s) to unprotected networks.  If the implementation is
capable of such "line rate" operation, then it is not necessary to
perform the preliminary verification stage described below.<a href="#section-4.5.3-4" class="pilcrow">¶</a></p>
<p id="section-4.5.3-5">The preliminary Sequence Number check is effected utilizing the
Sequence Number value in the EESP Header and is performed prior to
integrity checking and decryption.  If this preliminary check fails,<a href="#section-4.5.3-5" class="pilcrow">¶</a></p>
<p id="section-4.5.3-6">the packet is discarded, thus avoiding the need for any cryptographic
operations by the receiver.  If the preliminary check is successful,
the receiver cannot yet modify its local counter, because the
integrity of the Sequence Number has not been verified at this point.<a href="#section-4.5.3-6" class="pilcrow">¶</a></p>
<p id="section-4.5.3-7">Duplicates are rejected through the use of a sliding receive window.
How the window is implemented is a local matter, but the following
text describes the functionality that the implementation must
exhibit.<a href="#section-4.5.3-7" class="pilcrow">¶</a></p>
<p id="section-4.5.3-8">The "right" edge of the window represents the highest, validated
Sequence Number value received on this Sub SA.  Packets that contain
sequence numbers lower than the "left" edge of the window are
rejected.  Packets falling within the window are checked against a
list of received packets within the window.<a href="#section-4.5.3-8" class="pilcrow">¶</a></p>
<p id="section-4.5.3-9">If the received packet falls within the window and is not a
duplicate, or if the packet is to the right of the window,
receiver proceeds with cryptographic processing, i.e.
integrity check along with decryption.
If the integrity check fails, the receiver MUST discard the
received IP datagram as invalid; this is an auditable event.  The
audit log entry for this event SHOULD include the SPI value, Session ID value,
date/time received, Source Address, Destination Address, the Sequence
Number, and (in IPv6) the Flow ID.  The receive window is updated
only if the integrity verification succeeds.  (If a combined mode
algorithm is being used, then the integrity protected Sequence Number
must also match the Sequence Number used for anti-replay protection.)<a href="#section-4.5.3-9" class="pilcrow">¶</a></p>
<p id="section-4.5.3-10">A minimum window size of 64 packets MUST be supported.
Another window size (larger than
the minimum) MAY be chosen by the receiver.  (The receiver does NOT
notify the sender of the window size.)  The receive window size
should be increased for higher-speed environments, irrespective of
assurance issues.  Values for minimum and recommended receive window
sizes for very high-speed (e.g., multi-terabit/second) devices are
not specified by this standard.<a href="#section-4.5.3-10" class="pilcrow">¶</a></p>
</section>
<section id="section-4.5.4">
          <h4 id="name-packet-decryption-and-integ">
<a href="#section-4.5.4" class="section-number selfRef">4.5.4. </a><a href="#name-packet-decryption-and-integ" class="section-name selfRef">Packet Decryption and Integrity Check Value Verification</a>
          </h4>
<section id="section-4.5.4.1">
            <h5 id="name-combined-confidentiality-and">
<a href="#section-4.5.4.1" class="section-number selfRef">4.5.4.1. </a><a href="#name-combined-confidentiality-and" class="section-name selfRef">Combined Confidentiality and Integrity Algorithms</a>
            </h5>
<p id="section-4.5.4.1-1">The receiver proceeds for combined mode algorithms as follows:<a href="#section-4.5.4.1-1" class="pilcrow">¶</a></p>
<ol start="1" type="1" class="normal type-1" id="section-4.5.4.1-2">
<li id="section-4.5.4.1-2.1">
                <p id="section-4.5.4.1-2.1.1">Decrypts and integrity checks the EESP Payload Info Header (if present),
Payload Data, Padding, using the key, algorithm,
algorithm mode, and cryptographic synchronization data (if
any), indicated by the SA.
The Base Header and the Peer Header are are inputs
to this algorithm, as they are required for the integrity
check.<a href="#section-4.5.4.1-2.1.1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.5.4.1-2.1.2.1">
                    <p id="section-4.5.4.1-2.1.2.1.1">If explicit cryptographic synchronization data, e.g.,
an IV, is indicated, it is taken from the IV
field and input to the decryption algorithm as per
the algorithm specification.<a href="#section-4.5.4.1-2.1.2.1.1" class="pilcrow">¶</a></p>
</li>
                  <li class="normal" id="section-4.5.4.1-2.1.2.2">
                    <p id="section-4.5.4.1-2.1.2.2.1">If implicit cryptographic synchronization data, e.g.,
an IV, is indicated, a local version of the IV is
constructed and input to the decryption algorithm as
per the algorithm specification.<a href="#section-4.5.4.1-2.1.2.2.1" class="pilcrow">¶</a></p>
</li>
                </ul>
</li>
              <li id="section-4.5.4.1-2.2">
                <p id="section-4.5.4.1-2.2.1">If the integrity check performed by the combined mode
algorithm fails, the receiver MUST discard the received IP
datagram as invalid; this is an auditable event.  The log
data SHOULD include the SPI value, Session ID value, date/time received,
Source Address, Destination Address, the Sequence Number,
andF (in IPv6) the cleartext Flow ID.<a href="#section-4.5.4.1-2.2.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.4.1-2.3">
                <p id="section-4.5.4.1-2.3.1">Process any Padding as specified in the encryption algorithm
specification, if the algorithm has not already done so.<a href="#section-4.5.4.1-2.3.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.4.1-2.4">
                <p id="section-4.5.4.1-2.4.1">The receiver checks the Next Header field.  If the value is
"59" (no next header), the (dummy) packet is discarded
without further processing.<a href="#section-4.5.4.1-2.4.1" class="pilcrow">¶</a></p>
</li>
              <li id="section-4.5.4.1-2.5">
                <p id="section-4.5.4.1-2.5.1">Extract the original IP datagram (tunnel mode) or
transport-layer frame (layer 4 payload encapsulation modes) from the ESP Payload
Data field.<a href="#section-4.5.4.1-2.5.1" class="pilcrow">¶</a></p>
</li>
            </ol>
<p id="section-4.5.4.1-3">The exact steps for reconstructing the original datagram
depend on the mode. Transport and Tunnel mode are described in the
Security Architecture document <span>[<a href="#RFC4301" class="cite xref">RFC4301</a>]</span>. BEET Mode is described
in <span>[<a href="#RFC7402" class="cite xref">RFC7402</a>]</span> and IP-TFS in <span>[<a href="#RFC9347" class="cite xref">RFC9347</a>]</span>.
At a minimum, in an IPv6 context, the receiver SHOULD ensure that the
decrypted data is 8-byte aligned, to facilitate processing by the
protocol identified in the Next Header field.<a href="#section-4.5.4.1-3" class="pilcrow">¶</a></p>
</section>
</section>
</section>
</section>
<div id="sec-key-derivation-for-sub-sas">
<section id="section-5">
      <h2 id="name-key-derivation-for-sub-sas">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-key-derivation-for-sub-sas" class="section-name selfRef">Key Derivation for Sub SAs</a>
      </h2>
<p id="section-5-1">When an EESP SA is using Sub SAs, each Sub SA (including the one
with Session ID 0) uses separate keys. This allows each Sub SA to use
its own independent Sequence Number and IV space.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">In order to derive these keys, a Sub SA Key Derivation Function
(SSKDF) MUST be configured as a property of the EESP SA if Sub SAs
are to be used. If no SSKDF is configured, Sub SAs can't be used.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">If an SSKDF is set, the key material required for the EESP SA is
determined by the key size of the negotiated SSKDF.  This single
key is called '<code>root</code>' key and is the basis for the keys derived for
all Sub SAs.<a href="#section-5-3" class="pilcrow">¶</a></p>
<p id="section-5-4">The EESP SA root key and selected SSKDF are then used as follows to
derive key material for each Sub SA:<a href="#section-5-4" class="pilcrow">¶</a></p>
<p id="section-5-5">KEYMAT_sub = SSKDF(KEY_root, Session ID, L)<a href="#section-5-5" class="pilcrow">¶</a></p>
<p id="section-5-6">Where L is the total length of the key material KEYMAT_sub and the
salt value is the full Session ID field of the Sub SA. The length of
KEYMAT_sub and how it is used depends on the negotiated encryption
algorithm.<a href="#section-5-6" class="pilcrow">¶</a></p>
<p id="section-5-7">Keys for Sub SAs may be derived immediately or on demand when the
first packet is processed. Memory constrained implementations may
even decide to derive the Sub SA keys on the fly for each received
packet as only the EESP key has to be stored to derive the keys of
all Sub SAs.<a href="#section-5-7" class="pilcrow">¶</a></p>
<p id="section-5-8">Because individual Sub SAs can't be rekeyed, the complete EESP SA
MUST be rekeyed when either a cryptographic limit or a time-based
limit is reached for any individual Sub SA.<a href="#section-5-8" class="pilcrow">¶</a></p>
</section>
</div>
<section id="section-6">
      <h2 id="name-udp-encapsulation">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-udp-encapsulation" class="section-name selfRef">UDP Encapsulation</a>
      </h2>
<p id="section-6-1">UDP encapsulation for EESP is largely the same as UDP encapsulation
for ESP specified in <span>[<a href="#RFC3948" class="cite xref">RFC3948</a>]</span>.  The primary difference is that
the UDP source port used by EESP Sub SAs may be different from the
IKE SA source port.  This allows more flexible handling of EESP
traffic, particularly ECMP support along the path and in the NIC.<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">A receiver intending to support both ESP and EESP encapsulated in UDP
must be able to distinguish inbound ESP and EESP traffic on the same
UDP port. To be able to handle this, the SPIs for the incoming ESP
SAs MUST be chosen in such a way, that they can be distinguished from
the EESP base header. Since the most significant bit of the EESP base
header is fixed to be one, this can be achieved if ESP SPIs are
selected in such a way, that the most significant bit of the ESP SPIs
is always set to zero.<a href="#section-6-2" class="pilcrow">¶</a></p>
<section id="section-6.1">
        <h3 id="name-udp-encapsulation-of-sub-sa">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-udp-encapsulation-of-sub-sa" class="section-name selfRef">UDP Encapsulation of Sub SAs</a>
        </h3>
<p id="section-6.1-1">An EESP SA primarily uses UDP encapsulation to facilitate NAT
traversal. However, an additional use case for UDP encapsulation is
to introduce source port entropy, which supports ECMP or/and
RSS (Receive Side Scaling) mechanisms. In such scenarios, the
initiator MAY also use a distinct, ephemeral source port for
Sub SA IDs greater than zero.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">It is important to note that IKE messages MUST NOT utilize these
ephemeral source ports. Instead, IKE traffic should be confined to
the source and destination ports to ensure proper protocol operation
and maintain compatibility with existing implementations.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
<p id="section-6.1-3">When using ephemeral source ports, the receiver can only set the
source port upon arrival of an EESP packet with that Sub SA ID. If
the receiver is pre-populating a Sub SA, it may have to install it
with a source port set to zero and, upon arrival of a packet,
update the source port using a mapping change.<a href="#section-6.1-3" class="pilcrow">¶</a></p>
<p id="section-6.1-4">Additionally, when multiple Sub SAs exist, the receiver can
maintain a mapping table to track the source port associated with
each Sub SA independently. This ensures the packets of the same Sub SA
therefore the same Layer 4 flows are steered to the same NIC queue or
CPU to prevents state locking in handling packets associated with
different Sub SAs.<a href="#section-6.1-4" class="pilcrow">¶</a></p>
</section>
</section>
<section id="section-7">
      <h2 id="name-auditing">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-auditing" class="section-name selfRef">Auditing</a>
      </h2>
<p id="section-7-1">Not all systems that implement EESP will implement auditing.  However,
if EESP is incorporated into a system that supports auditing, then the
EESP implementation MUST also support auditing and MUST allow a system
administrator to enable or disable auditing for EESP.  For the most
part, the granularity of auditing is a local matter.  However,
several auditable events are identified in this specification and for
each of these events a minimum set of information that SHOULD be
included in an audit log is defined.<a href="#section-7-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-7-2.1">
          <p id="section-7-2.1.1">No valid Security Association exists for a session.  The
audit log entry for this event SHOULD include the SPI value,
Session ID value, date/time received, Source Address, Destination Address,
Sequence Number, and (for IPv6) the cleartext Flow ID.<a href="#section-7-2.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.2">
          <p id="section-7-2.2.1">A packet offered to EESP for processing appears to be an IP
fragment, i.e., the OFFSET field is non-zero or the MORE
FRAGMENTS flag is set.  The audit log entry for this event
SHOULD include the SPI value, Session ID value, date/time received, Source
Address, Destination Address, Sequence Number, and (in IPv6)
the Flow ID.<a href="#section-7-2.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.3">
          <p id="section-7-2.3.1">Attempt to transmit a packet that would result in Sequence
Number overflow.  The audit log entry for this event SHOULD
include the SPI value, Session ID value, current date/time, Source Address,
Destination Address, Sequence Number, and (for IPv6) the
cleartext Flow ID.<a href="#section-7-2.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.4">
          <p id="section-7-2.4.1">The received packet fails the anti-replay checks.  The audit
log entry for this event SHOULD include the SPI value, Session ID value,
date/time received, Source Address, Destination Address, the
Sequence Number, and (in IPv6) the Flow ID.<a href="#section-7-2.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-7-2.5">
          <p id="section-7-2.5.1">The integrity check fails.  The audit log entry for this
event SHOULD include the SPI value, Session ID value, date/time received,
Source Address, Destination Address, the Sequence Number, and
(for IPv6) the Flow ID.<a href="#section-7-2.5.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-7-3">Additional information also MAY be included in the audit log for each
of these events, and additional events, not explicitly called out in
this specification, also MAY result in audit log entries.  There is
no requirement for the receiver to transmit any message to the
purported sender in response to the detection of an auditable event,
because of the potential to induce denial of service via such action.<a href="#section-7-3" class="pilcrow">¶</a></p>
</section>
<section id="section-8">
      <h2 id="name-conformance-requirements">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-conformance-requirements" class="section-name selfRef">Conformance Requirements</a>
      </h2>
<p id="section-8-1">Implementations that claim conformance or compliance with this
specification MUST implement the EESP syntax and processing described
here for unicast traffic, and MUST comply with all additional packet
processing requirements levied by the Security Architecture document
<span>[<a href="#RFC4301" class="cite xref">RFC4301</a>]</span>.  Additionally, if an implementation claims to support
multicast traffic, it MUST comply with the additional requirements
specified for support of such traffic.  If the key used to compute an
ICV is manually distributed, correct provision of the anti-replay
service requires correct maintenance of the counter state at the
sender (across local reboots, etc.), until the key is replaced, and
there likely would be no automated recovery provision if counter
overflow were imminent.  Thus, a compliant implementation SHOULD NOT
provide anti-replay service in conjunction with SAs that are manually
keyed.<a href="#section-8-1" class="pilcrow">¶</a></p>
<p id="section-8-2">The mandatory-to-implement algorithms for use with EESP described
in a separate RFC, for e.g. RFC8221bis or another I.D., to facilitate
updating the algorithm requirements independently from the protocol
per se.  Additional algorithms, beyond those mandated for EESP, MAY
be supported.<a href="#section-8-2" class="pilcrow">¶</a></p>
</section>
<section id="section-9">
      <h2 id="name-security-considerations">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<p id="section-9-1">Security is central to the design of this protocol, and thus security
considerations permeate the specification.  Additional security-
relevant aspects of using the IPsec protocol are discussed in the
Security Architecture document.<a href="#section-9-1" class="pilcrow">¶</a></p>
</section>
<section id="section-10">
      <h2 id="name-iana-considerations">
<a href="#section-10" class="section-number selfRef">10. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<section id="section-10.1">
        <h3 id="name-eesp-ip-protocol-number">
<a href="#section-10.1" class="section-number selfRef">10.1. </a><a href="#name-eesp-ip-protocol-number" class="section-name selfRef">EESP IP Protocol Number</a>
        </h3>
<p id="section-10.1-1">This document requests IANA allocate an IP protocol number from
"Protocol Numbers - Assigned Internet Protocol Numbers" registry<a href="#section-10.1-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.1-2.1">
            <p id="section-10.1-2.1.1">Decimal: TBD<a href="#section-10.1-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.1-2.2">
            <p id="section-10.1-2.2.1">Keyword: EESP<a href="#section-10.1-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.1-2.3">
            <p id="section-10.1-2.3.1">Protocol: Enhanced Encapsulating Security Payload<a href="#section-10.1-2.3.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.1-2.4">
            <p id="section-10.1-2.4.1">Reference: This document<a href="#section-10.1-2.4.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
<section id="section-10.2">
        <h3 id="name-eesp-versions-registry">
<a href="#section-10.2" class="section-number selfRef">10.2. </a><a href="#name-eesp-versions-registry" class="section-name selfRef">EESP Versions Registry</a>
        </h3>
<p id="section-10.2-1">This document requests IANA to create a registry called "EESP_VERSIONS"
Type Registry" under a new category named "EESP_VERSIONS Parameters".<a href="#section-10.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.2-2.1">
            <p id="section-10.2-2.1.1">Name: EESP Versions Registry<a href="#section-10.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.2-2.2">
            <p id="section-10.2-2.2.1">Description: EESP Base Header Version<a href="#section-10.2-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.2-2.3">
            <p id="section-10.2-2.3.1">Reference: This document<a href="#section-10.2-2.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-10.2-3">The initial content for this registry is as follows:<a href="#section-10.2-3" class="pilcrow">¶</a></p>
<span id="name-eesp-version-initial-regist"></span><div id="iana_requests_versions_reg">
<figure id="figure-21">
          <div class="sourcecode" id="section-10.2-4.1">
<pre>
Value     EESP Version                      Reference
-------   ------------------------------    ---------------
    0      V0                              [this document]
  1-13     Unassigned                      [this document]
 13-15     Private Use                     [this document]
</pre>
</div>
<figcaption><a href="#figure-21" class="selfRef">Figure 21</a>:
<a href="#name-eesp-version-initial-regist" class="selfRef">EESP Version Initial Registry Values</a>
          </figcaption></figure>
</div>
</section>
<section id="section-10.3">
        <h3 id="name-eesp-options-registry">
<a href="#section-10.3" class="section-number selfRef">10.3. </a><a href="#name-eesp-options-registry" class="section-name selfRef">EESP Options Registry</a>
        </h3>
<p id="section-10.3-1">This document requests IANA to create a registry called "EESP_OPTIONS
Type Registry" under a new category named "EESP_OPTIONS Parameters".<a href="#section-10.3-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-10.3-2.1">
            <p id="section-10.3-2.1.1">Name: EESP Options Registry<a href="#section-10.3-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.3-2.2">
            <p id="section-10.3-2.2.1">Description: EESP Base Header Options<a href="#section-10.3-2.2.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-10.3-2.3">
            <p id="section-10.3-2.3.1">Reference: This document<a href="#section-10.3-2.3.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-10.3-3">The initial content for this registry is as follows:<a href="#section-10.3-3" class="pilcrow">¶</a></p>
<span id="name-initial-registry-values"></span><div id="iana_requests_options_reg">
<figure id="figure-22">
          <div class="sourcecode" id="section-10.3-4.1">
<pre>
Value     EESP Header Options Types         Reference
-------   ------------------------------    ---------------
      0   Pad1                              [this document]
      1   PadN                              [this document]
      2   Crypt Offset                      [this document]
      3   FID                               [this document]
  4-223   Unassigned                        [this document]
224-255   Private                           [this document]
</pre>
</div>
<figcaption><a href="#figure-22" class="selfRef">Figure 22</a>:
<a href="#name-initial-registry-values" class="selfRef">Initial Registry Values</a>
          </figcaption></figure>
</div>
</section>
</section>
<section id="section-11">
      <h2 id="name-implementation-status">
<a href="#section-11" class="section-number selfRef">11. </a><a href="#name-implementation-status" class="section-name selfRef">Implementation Status</a>
      </h2>
<p id="section-11-1">[Note to RFC Editor: Please remove this section and the reference to
<span>[<a href="#RFC7942" class="cite xref">RFC7942</a>]</span> before publication.]<a href="#section-11-1" class="pilcrow">¶</a></p>
<p id="section-11-2">This section records the status of known implementations of the
protocol defined by this specification at the time of posting of this
Internet-Draft, and is based on a proposal described in <span>[<a href="#RFC7942" class="cite xref">RFC7942</a>]</span>.
The description of implementations in this section is intended to
assist the IETF in its decision processes in progressing drafts to
RFCs. Please note that the listing of any individual implementation
here does not imply endorsement by the IETF. Furthermore, no effort
has been spent to verify the information presented here that was
supplied by IETF contributors. This is not intended as, and must not
be construed to be, a catalog of available implementations or their
features. Readers are advised to note that other implementations may
exist.<a href="#section-11-2" class="pilcrow">¶</a></p>
<p id="section-11-3">According to <span>[<a href="#RFC7942" class="cite xref">RFC7942</a>]</span>, "this will allow reviewers and working
groups to assign due consideration to documents that have the benefit
of running code, which may serve as evidence of valuable
experimentation and feedback that have made the implemented protocols
more mature. It is up to the individual working groups to use this
information as they see fit".<a href="#section-11-3" class="pilcrow">¶</a></p>
<p id="section-11-4">Authors are requested to add a note to the RFC Editor at the top of
this section, advising the Editor to remove the entire section before
publication, as well as the reference to <span>[<a href="#RFC7942" class="cite xref">RFC7942</a>]</span>.<a href="#section-11-4" class="pilcrow">¶</a></p>
</section>
<section id="section-12">
      <h2 id="name-acknowledgments">
<a href="#section-12" class="section-number selfRef">12. </a><a href="#name-acknowledgments" class="section-name selfRef">Acknowledgments</a>
      </h2>
<p id="section-12-1">TBD<a href="#section-12-1" class="pilcrow">¶</a></p>
</section>
<section id="section-13">
      <h2 id="name-normative-references">
<a href="#section-13" class="section-number selfRef">13. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
      </h2>
<dl class="references">
<dt id="RFC2119">[RFC2119]</dt>
      <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4301">[RFC4301]</dt>
      <dd>
<span class="refAuthor">Kent, S.</span> and <span class="refAuthor">K. Seo</span>, <span class="refTitle">"Security Architecture for the Internet Protocol"</span>, <span class="seriesInfo">RFC 4301</span>, <span class="seriesInfo">DOI 10.17487/RFC4301</span>, <time datetime="2005-12" class="refDate">December 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4301">https://www.rfc-editor.org/info/rfc4301</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4303">[RFC4303]</dt>
      <dd>
<span class="refAuthor">Kent, S.</span>, <span class="refTitle">"IP Encapsulating Security Payload (ESP)"</span>, <span class="seriesInfo">RFC 4303</span>, <span class="seriesInfo">DOI 10.17487/RFC4303</span>, <time datetime="2005-12" class="refDate">December 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4303">https://www.rfc-editor.org/info/rfc4303</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4494">[RFC4494]</dt>
      <dd>
<span class="refAuthor">Song, JH.</span>, <span class="refAuthor">Poovendran, R.</span>, and <span class="refAuthor">J. Lee</span>, <span class="refTitle">"The AES-CMAC-96 Algorithm and Its Use with IPsec"</span>, <span class="seriesInfo">RFC 4494</span>, <span class="seriesInfo">DOI 10.17487/RFC4494</span>, <time datetime="2006-06" class="refDate">June 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4494">https://www.rfc-editor.org/info/rfc4494</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7296">[RFC7296]</dt>
      <dd>
<span class="refAuthor">Kaufman, C.</span>, <span class="refAuthor">Hoffman, P.</span>, <span class="refAuthor">Nir, Y.</span>, <span class="refAuthor">Eronen, P.</span>, and <span class="refAuthor">T. Kivinen</span>, <span class="refTitle">"Internet Key Exchange Protocol Version 2 (IKEv2)"</span>, <span class="seriesInfo">STD 79</span>, <span class="seriesInfo">RFC 7296</span>, <span class="seriesInfo">DOI 10.17487/RFC7296</span>, <time datetime="2014-10" class="refDate">October 2014</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7296">https://www.rfc-editor.org/info/rfc7296</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7402">[RFC7402]</dt>
      <dd>
<span class="refAuthor">Jokela, P.</span>, <span class="refAuthor">Moskowitz, R.</span>, and <span class="refAuthor">J. Melen</span>, <span class="refTitle">"Using the Encapsulating Security Payload (ESP) Transport Format with the Host Identity Protocol (HIP)"</span>, <span class="seriesInfo">RFC 7402</span>, <span class="seriesInfo">DOI 10.17487/RFC7402</span>, <time datetime="2015-04" class="refDate">April 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7402">https://www.rfc-editor.org/info/rfc7402</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8200">[RFC8200]</dt>
      <dd>
<span class="refAuthor">Deering, S.</span> and <span class="refAuthor">R. Hinden</span>, <span class="refTitle">"Internet Protocol, Version 6 (IPv6) Specification"</span>, <span class="seriesInfo">STD 86</span>, <span class="seriesInfo">RFC 8200</span>, <span class="seriesInfo">DOI 10.17487/RFC8200</span>, <time datetime="2017-07" class="refDate">July 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8200">https://www.rfc-editor.org/info/rfc8200</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC9347">[RFC9347]</dt>
    <dd>
<span class="refAuthor">Hopps, C.</span>, <span class="refTitle">"Aggregation and Fragmentation Mode for Encapsulating Security Payload (ESP) and Its Use for IP Traffic Flow Security (IP-TFS)"</span>, <span class="seriesInfo">RFC 9347</span>, <span class="seriesInfo">DOI 10.17487/RFC9347</span>, <time datetime="2023-01" class="refDate">January 2023</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9347">https://www.rfc-editor.org/info/rfc9347</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="section-14">
      <h2 id="name-informative-references">
<a href="#section-14" class="section-number selfRef">14. </a><a href="#name-informative-references" class="section-name selfRef">Informative References</a>
      </h2>
<dl class="references">
<dt id="I-D.he-ipsecme-vpn-shared-ipsecsa">[I-D.he-ipsecme-vpn-shared-ipsecsa]</dt>
      <dd>
<span class="refAuthor">He, Q.</span>, <span class="refAuthor">Pan, W.</span>, <span class="refAuthor">Chen, X.</span>, and <span class="refAuthor">B. Ding</span>, <span class="refTitle">"Shared Use of IPsec Tunnel in a Multi-VPN Environment"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-he-ipsecme-vpn-shared-ipsecsa-01</span>, <time datetime="2024-07-08" class="refDate">8 July 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-he-ipsecme-vpn-shared-ipsecsa-01">https://datatracker.ietf.org/doc/html/draft-he-ipsecme-vpn-shared-ipsecsa-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.mrossberg-ipsecme-multiple-sequence-counters">[I-D.mrossberg-ipsecme-multiple-sequence-counters]</dt>
      <dd>
<span class="refAuthor">Rossberg, M.</span>, <span class="refAuthor">Klassert, S.</span>, and <span class="refAuthor">M. Pfeiffer</span>, <span class="refTitle">"Broadening the Scope of Encapsulating Security Payload (ESP) Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-mrossberg-ipsecme-multiple-sequence-counters-02</span>, <time datetime="2024-02-15" class="refDate">15 February 2024</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-mrossberg-ipsecme-multiple-sequence-counters-02">https://datatracker.ietf.org/doc/html/draft-mrossberg-ipsecme-multiple-sequence-counters-02</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="I-D.ponchon-ipsecme-anti-replay-subspaces">[I-D.ponchon-ipsecme-anti-replay-subspaces]</dt>
      <dd>
<span class="refAuthor">Ponchon, P.</span>, <span class="refAuthor">Shaikh, M.</span>, <span class="refAuthor">Dernaika, H.</span>, <span class="refAuthor">Pfister, P.</span>, and <span class="refAuthor">G. Solignac</span>, <span class="refTitle">"IPsec and IKE anti-replay sequence number subspaces for traffic-engineered paths and multi-core processing"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ponchon-ipsecme-anti-replay-subspaces-03</span>, <time datetime="2023-10-23" class="refDate">23 October 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ponchon-ipsecme-anti-replay-subspaces-03">https://datatracker.ietf.org/doc/html/draft-ponchon-ipsecme-anti-replay-subspaces-03</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="NIST01">[NIST01]</dt>
      <dd>
<span class="refAuthor">NIST</span>, <span class="refTitle">"Federal Information Processing Standards Publication 140-2 (FIPS PUB 140-2), "Security Requirements for Cryptographic Modules", Information Technology Laboratory, National Institute of Standards and Technology, May 25, 2001."</span>. </dd>
<dd class="break"></dd>
<dt id="Protocol">[Protocol]</dt>
      <dd>
<span class="refAuthor">IANA</span>, <span class="refTitle">"Assigned Internet Protocol Numbers"</span>, <span>&lt;<a href="https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml">https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PSP">[PSP]</dt>
      <dd>
<span class="refAuthor">Google</span>, <span class="refTitle">"PSP Architecture Specification"</span>, <span>&lt;<a href="https://github.com/google/psp/blob/main/doc/PSP_Arch_Spec.pdf">https://github.com/google/psp/blob/main/doc/PSP_Arch_Spec.pdf</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2992">[RFC2992]</dt>
      <dd>
<span class="refAuthor">Hopps, C.</span>, <span class="refTitle">"Analysis of an Equal-Cost Multi-Path Algorithm"</span>, <span class="seriesInfo">RFC 2992</span>, <span class="seriesInfo">DOI 10.17487/RFC2992</span>, <time datetime="2000-11" class="refDate">November 2000</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2992">https://www.rfc-editor.org/info/rfc2992</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC3948">[RFC3948]</dt>
      <dd>
<span class="refAuthor">Huttunen, A.</span>, <span class="refAuthor">Swander, B.</span>, <span class="refAuthor">Volpe, V.</span>, <span class="refAuthor">DiBurro, L.</span>, and <span class="refAuthor">M. Stenberg</span>, <span class="refTitle">"UDP Encapsulation of IPsec ESP Packets"</span>, <span class="seriesInfo">RFC 3948</span>, <span class="seriesInfo">DOI 10.17487/RFC3948</span>, <time datetime="2005-01" class="refDate">January 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc3948">https://www.rfc-editor.org/info/rfc3948</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4106">[RFC4106]</dt>
      <dd>
<span class="refAuthor">Viega, J.</span> and <span class="refAuthor">D. McGrew</span>, <span class="refTitle">"The Use of Galois/Counter Mode (GCM) in IPsec Encapsulating Security Payload (ESP)"</span>, <span class="seriesInfo">RFC 4106</span>, <span class="seriesInfo">DOI 10.17487/RFC4106</span>, <time datetime="2005-06" class="refDate">June 2005</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4106">https://www.rfc-editor.org/info/rfc4106</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC4543">[RFC4543]</dt>
      <dd>
<span class="refAuthor">McGrew, D.</span> and <span class="refAuthor">J. Viega</span>, <span class="refTitle">"The Use of Galois Message Authentication Code (GMAC) in IPsec ESP and AH"</span>, <span class="seriesInfo">RFC 4543</span>, <span class="seriesInfo">DOI 10.17487/RFC4543</span>, <time datetime="2006-05" class="refDate">May 2006</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc4543">https://www.rfc-editor.org/info/rfc4543</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7634">[RFC7634]</dt>
      <dd>
<span class="refAuthor">Nir, Y.</span>, <span class="refTitle">"ChaCha20, Poly1305, and Their Use in the Internet Key Exchange Protocol (IKE) and IPsec"</span>, <span class="seriesInfo">RFC 7634</span>, <span class="seriesInfo">DOI 10.17487/RFC7634</span>, <time datetime="2015-08" class="refDate">August 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7634">https://www.rfc-editor.org/info/rfc7634</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC7942">[RFC7942]</dt>
      <dd>
<span class="refAuthor">Sheffer, Y.</span> and <span class="refAuthor">A. Farrel</span>, <span class="refTitle">"Improving Awareness of Running Code: The Implementation Status Section"</span>, <span class="seriesInfo">BCP 205</span>, <span class="seriesInfo">RFC 7942</span>, <span class="seriesInfo">DOI 10.17487/RFC7942</span>, <time datetime="2016-07" class="refDate">July 2016</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7942">https://www.rfc-editor.org/info/rfc7942</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8750">[RFC8750]</dt>
    <dd>
<span class="refAuthor">Migault, D.</span>, <span class="refAuthor">Guggemos, T.</span>, and <span class="refAuthor">Y. Nir</span>, <span class="refTitle">"Implicit Initialization Vector (IV) for Counter-Based Ciphers in Encapsulating Security Payload (ESP)"</span>, <span class="seriesInfo">RFC 8750</span>, <span class="seriesInfo">DOI 10.17487/RFC8750</span>, <time datetime="2020-03" class="refDate">March 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8750">https://www.rfc-editor.org/info/rfc8750</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<section id="appendix-A">
      <h2 id="name-additional-stuff">
<a href="#appendix-A" class="section-number selfRef">Appendix A. </a><a href="#name-additional-stuff" class="section-name selfRef">Additional Stuff</a>
      </h2>
<p id="appendix-A-1">TBD<a href="#appendix-A-1" class="pilcrow">¶</a></p>
</section>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Steffen Klassert</span></div>
<div dir="auto" class="left"><span class="org">secunet Security Networks AG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:steffen.klassert@secunet.com" class="email">steffen.klassert@secunet.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Antony Antony</span></div>
<div dir="auto" class="left"><span class="org">secunet Security Networks AG</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:antony.antony@secunet.com" class="email">antony.antony@secunet.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christian Hopps</span></div>
<div dir="auto" class="left"><span class="org">LabN Consulting, L.L.C.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:chopps@chopps.org" class="email">chopps@chopps.org</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
